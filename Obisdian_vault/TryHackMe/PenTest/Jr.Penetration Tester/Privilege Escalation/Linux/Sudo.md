The sudo command, by default, allows you to run a program with root privileges. Under some conditions, system administrators may need to give regular users some flexibility on their privileges. For example, a junior SOC analyst may need to use Nmap regularly but would not be cleared for full root access. In this situation, the system administrator can allow this user to only run Nmap with root privileges while keeping its regular privilege level throughout the rest of the system. Any user can check its current situation related to root privileges using the `sudo -l` command.

- [https://gtfobins.github.io/](https://gtfobins.github.io/) is a valuable source that provides information on how any program, on which you may have sudo rights, can be used.

## Leverage application functions
Some applications will not have a known exploit within this context. Such an application you may see is the Apache2 server. In this case, we can use a "hack" to leak information leveraging a function of the application. 

Apache2 has an option that supports loading alternative configuration files (`-f` : specify an alternate ServerConfigFile). Loading the `/etc/shadow` file using this option will result in an error message that includes the first line of the `/etc/shadow` file.
	![[Pasted image 20240822024427.png]]

## Leverage LD_PRELOAD
On some systems, you may see the **LD_PRELOAD** environment option which is a function that allows any program to use shared libraries. If the `env_keep` option is enabled we can generate a shared library which will be loaded and executed before the program is run. 

*Note*
**LD_PRELOAD** option will be ignored if the real user ID is different from the effective user ID.

![[Pasted image 20240822024543.png]]

The steps of this privilege escalation vector can be summarized as follows:
1. Check for LD_PRELOAD (with the env_keep option);
2. Write a simple C code compiled as a share object (.so extension) file;
3. Save this code as shell.c and compile it using gcc into a shared object file using the following parameters:  `gcc -fPIC -shared -o shell.so shell.c -nostartfiles`;
4. Run the program with sudo rights and the LD_PRELOAD option pointing to our .so file: `sudo LD_PRELOAD=/home/user/ldpreload/shell.so find`;
	![[Pasted image 20240822024807.png]]![[Pasted image 20240822024823.png]]

## **Examples**
Q)How many programs can the user "karen" run on the target system with sudo rights?
	![[Pasted image 20240823201531.png]]

Q)What is the content of the flag2.txt file?
	![[Pasted image 20240823201710.png]]
	![[Pasted image 20240823201604.png]]

Q) How would you use Nmap to spawn a root shell if your user had sudo rights on nmap?
	![[Pasted image 20240823201734.png]]

Q) What is the hash of frank's password?
![[Pasted image 20240823202045.png]]
