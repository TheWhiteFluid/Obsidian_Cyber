
  
## **Privilege Escalation: PATH**
If a folder for which your user has write permission is located in the path, you could potentially hijack an application to run a script. PATH in Linux is an environmental variable that tells the operating system where to search for executables. For any command that is not built into the shell or that is not defined with an absolute path, Linux will start searching in folders defined under PATH. (PATH is the environmental variable we're talking about here, path is the location of a file).  

![[Pasted image 20240824013559.png]]

If we type “thm” to the command line, these are the locations Linux will look in for an executable called thm. The scenario below will give you a better idea of how this can be leveraged to increase our privilege level. As you will see, this depends entirely on the existing configuration of the target system, so be sure you can answer the questions below before trying this.
1. What folders are located under $PATH
2. Does your current user have write privileges for any of these folders?
3. Can you modify $PATH?
4. Is there a script/application you can start that will be affected by this vulnerability?


A simple search for writable folders can done using the “`find / -writable 2>/dev/null`” command. The output of this command can be cleaned using a simple cut and sort sequence.
	![[Pasted image 20240824015732.png]]

Comparing this with PATH will help us find folders we could use.
	![[Pasted image 20240824015830.png]]

Let's say that we find a script file in one of the directories:
	![[Pasted image 20240824020417.png]]

This script tries to launch a system binary called “thm” but the example can easily be replicated with any binary. We compile this into an executable and set the SUID bit.
	![](https://i.imgur.com/A6QQ65I.png)
	Our user now has access to the “path” script with SUID bit set.

Once executed “path” will look for an executable named “thm” inside folders listed under PATH.
If any writable folder is listed under PATH we could create a binary named thm under that directory and have our “path” script run it. As the SUID bit is set, this binary will run with root privilege.

We see a number of folders under /usr, thus it could be easier to run our writable folder search once more to cover subfolders.  Unfortunately, subfolders under /usr are not writable.

The folder that will be easier to write to is probably /tmp. At this point because /tmp is not present in PATH so we will need to add it. As we can see below, the “`export PATH=/tmp:$PATH`” command accomplishes this.
	![[Pasted image 20240824015928.png]]

At this point the path script will also look under the /tmp folder for an executable named “thm”. Creating this command is fairly easy by copying /bin/bash as “thm” under the /tmp folder.
	![[Pasted image 20240824020032.png]]

We have given executable rights to our copy of /bin/bash, please note that at this point it will run with our user’s right. What makes a privilege escalation possible within this context is that the path script runs with root privileges.
	![[Pasted image 20240824020108.png]]

Q)What is the odd folder you have write access for?
- `echo $PATH`
- `find / -writable 2>/dev/null | cut -d "/" -f 2,3 | sort -u`
  
  ![[Pasted image 20240824021450.png]]

Q)Exploit the $PATH vulnerability to read the content of the flag6.txt file.
	![[Pasted image 20240824021557.png]]
	![[Pasted image 20240824021755.png]]

- creating the thm that thm.py use and we are adding our exploit: `sudo su-` to gain root privilegies to acces matt files from home directory.
- we have to set chmod 777 to our thm created file and add it's path to the $PATH variable.
  `export PATH=/home/murdoch:$PATH`
	  ![[Pasted image 20240825200751.png]]

## **Privilege Escalation: NFS**
Privilege escalation vectors are not confined to internal access. Shared folders and remote management interfaces such as SSH and Telnet can also help you gain root access on the target system. Some cases will also require using both vectors, e.g. finding a root SSH private key on the target system and connecting via SSH with root privileges instead of trying to increase your current user’s privilege level.

Another vector that is more relevant to CTFs and exams is a misconfigured network shell. This vector can sometimes be seen during penetration testing engagements when a network backup system is present.

NFS (Network File Sharing) configuration is kept in the `/etc/exports` file. This file is created during the NFS server installation and can usually be read by users.
	![[Pasted image 20240825201119.png]]

The critical element for this privilege escalation vector is the `“no_root_squash`” option you can see above. By default, NFS will change the root user to nfsnobody and strip any file from operating with root privileges. If the “`no_root_squash`” option is present on a writable share, we can create an executable with SUID bit set and run it on the target system.

We will start by enumerating mountable shares from our attacking machine.
	![](https://i.imgur.com/CmXPDcv.png)

We will mount one of the “`no_root_squash`” shares to our attacking machine and start building our executable.
	![](https://i.imgur.com/DwAB1qs.png)

As we can set SUID bits, a simple executable that will run /bin/bash on the target system will do the job.
	![[Pasted image 20240825223435.png]]

Once we compile the code we will set the SUID bit
	![[Pasted image 20240825223511.png]]

You will see below that both files (nfs.c and nfs are present on the target system. We have worked on the mounted share so there was no need to transfer them). Notice the nfs executable has the SUID bit set on the target system and runs with root privileges.
	![[Pasted image 20240825223538.png]]

Q)How many mountable shares can you identify on the target system?
	![[Pasted image 20240825230634.png]]

Q)How many shares have the "no_root_squash" option enabled?
	![[Pasted image 20240825230536.png]]


Q)Gain a root shell on the target system
	- using our attaching machine -> display mountable directories of the target machine 
	- create a temporary directory named temp in /tmp
	- mount one of the no_root_squash directory on our machine inside of /tmp/temp directory
	- create a payload(/bin/bash reverse shell in C) that will be distributed trough NFS 
	- set SUID bit permission to the payload file from our attacking machine
	- run payload on the target machine --> root acces
	![[Pasted image 20240825231102.png]]
	![[Pasted image 20240825231856.png]]
	![[Pasted image 20240825231822.png]]
	![[Pasted image 20240825231922.png]]




