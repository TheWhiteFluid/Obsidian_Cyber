
## Enumeration
To effectively exploit a vulnerable session management lifecycle, we first need to map out the lifecycle for ourselves and capture detailed notes. Once we understand the intended lifecycle, we can start looking for weaknesses
	![](Pasted%20image%2020241127143210.png)

We first notice that we are not presented with any cookies or tokens when we first visit the page. This tells us that unauthenticated sessions are most likely not being tracked. If we click the Sign-Up button, we see that there are two main signups:
- Student - This can be used by anyone to create a profile
- Lecturer - Requires a verification code for the signup process

This shows us that even without any brute-force techniques, we can kick off the session management lifecycle by creating a student account. Let's create a student account and see what happens:
	![](Pasted%20image%2020241127143406.png)
After creating the user account, we receive a prompt that the account has been created, and we are navigated back to the login page. Let's perform a login as our user and monitor the network traffic:
	![](Pasted%20image%2020241127143559.png)
This tells us quite a bit of information:
- Cookies are being used for session management.
- The HTTPOnly flag is set which means we would not be able to leverage JavaScript to read the cookie value.
- The cookie expiry time seems weird since both the creation and expiry times for the cookie are the exact same.

With this authentication, we also notice that we now have access to more functionality:
	![](Pasted%20image%2020241127144002.png)
Using the menu navigation and reviewing the network traffic, we can see that session tracking is enforced through the cookie that is being transmitted with each request:
	![](Pasted%20image%2020241127144218.png)
An interesting thing to note is that even though the cookie expiry time has been reached, the same set cookie header is used to refresh the cookie to the exact same value. This might point to a persistent cookie. Let's see what happens when we remove this cookie. Under storage, remove the cookie and make the module request again:
	![](Pasted%20image%2020241127144424.png)
The request seems to still succeed? However, if you take a closer look, you will see that we can now only see the modules but not the number of enrolled students or the potential tests:
	![](Pasted%20image%2020241127144508.png)
This tells us that we might need to do further investigation to determine exactly what we are allowed to access from a completely unauthenticated perspective. This would warrant further investigation to fully map out the session management lifecycle. However, we will keep things slightly simpler. Let's take a look at the logout functionality. Once we press the logout button, we can see that our session is removed client-side:
	![](Pasted%20image%2020241127144539.png)
We should probably test if the session is also terminated server-side. You can re-authenticate to the application and replace your new cookie with your old cookie value. But, it does seem like the session termination is working to some capacity as you get a 500 Internal Server Error when you refresh the page. This does tell us that there is something wrong here, since an invalid session should not lead to an internal server error. Let's investigate.

Let's revisit some of our previous claims here. If we navigate to the Local Storage, we do notice quite a bit of data is being stored:
	![](Pasted%20image%2020241127144833.png)
Let's play around by updating our *userRole* from student to lecturer and refreshing the page:
	![](Pasted%20image%2020241127144910.png)
	
While we now have access to more tabs, it seems like we don't have access to more information since we can see any students or test attempts. Let's take this further by updating our role in the user value from a 2 to a 3. Sadly, this still gives us the same results. However, there are more values to play with here, such as our id and username. We will have to come back to this. However, this new information tells us that the sessions might be managed not purely through a cookie but through token information.

Now, we have mapped out the session management lifecycle. Let's take a look:

|                     |                                                                                                  |
| ------------------- | ------------------------------------------------------------------------------------------------ |
| **Lifecycle Phase** | **Observation**                                                                                  |
| Session Creation    | A combination of cookie- and token-based session management is being used                        |
| Session Creation    | A new session value is provided for each login attempt                                           |
| Session Creation    | The session value itself appears to be sufficiently random                                       |
| Session Tracking    | Unauthenticated actions are not tracked via a session                                            |
| Session Tracking    | The cookie is sent in each request for tracking                                                  |
| Session Tracking    | Several requests can be made without a cookie                                                    |
| Session Tracking    | The initial token values that are loaded post-authentication dictate the visible information     |
| Session Expiry      | There is a mismatch between the client-side and server-side expiry times                         |
| Session Expiry      | The expiry time is incredibly long                                                               |
| Session Termination | Users can forcibly terminate their session                                                       |
| Session Termination | Sessions are terminated server-side but reusing an old session leads to an internal server error |

Given all of this information, we would already report the following vulnerabilities on a security assessment:
- *Excessive Session Lifetimes*

We would also need to investigate the following further:
- *Access controls on all API endpoints*
- *Web application logs for the accountability of actions*

# Exploitation
Given all of the information provided above, it seems like we need to do a little bit more exploring to see if we can access sensitive data. Using the information you learned about securing the session management lifecycle and the information of the mapped-out lifecycle, see if you can get access as a student to lecturer information and answer the questions below.

if we are searching for request from 'admin' in the network tab we discover another role
	![](Pasted%20image%2020241127154544.png)
on local storage we will change the role to impersonate admin and see its page content
	![](Pasted%20image%2020241127154412.png)


