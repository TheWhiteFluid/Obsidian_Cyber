While secure coding practices are essential, it is also important to recognise how a developer might inadvertently implement a vulnerable version of an ORM, creating avenues for exploitation. Vulnerable implementations can occur when developers use **outdated or misconfigured ORM libraries** that contain inherent security flaws. These flaws can be exploited by attackers to manipulate database queries and gain unauthorised access or control. Such vulnerabilities may stem from issues like improper handling of query parameters or inadequate protection against injection attacks within the ORM framework itself. Developers must ensure they are using up-to-date and secure versions of ORM libraries to avoid introducing exploitable vulnerabilities into their applications.

## Example
One such example is the Laravel query builder package, which had a significant security vulnerability in versions prior to 1.17.1. This vulnerability allowed SQL injection through unsanitised query parameters. The vulnerability was identified in how the package handled sorting parameters directly from user input without proper validation. We have used the [Spatie query builder](https://github.com/spatie/laravel-query-builder) in this example, which also uses the Laravel query builder internally to make queries.

To demonstrate this vulnerability, you can access the machine at [https://10-10-133-129.p.thmlabs.com/query_users?sort=name](https://10-10-133-129.p.thmlabs.com/query_users?sort=name). This endpoint allows getting the top users sorted by the `name` column via the `sort` parameter.
	![](Pasted%20image%2020250112195037.png)
The Laravel equivalent translation of the query is `SELECT * FROM users ORDER BY name ASC LIMIT 2`.

If we try injecting the name parameter with `name'`, we will see that the app returns an error that it couldn’t find the column name.
	![](Pasted%20image%2020250112195140.png)

Our objective here is to manipulate the query to retrieve complete data from the `users` table instead of being restricted to a limited number of rows. 

However, injecting the sort parameter in this context is not straightforward by merely concatenating it with the `SELECT` query and using routine injection methods. The challenge lies in effectively breaking out of the ORDER BY clause to manipulate the query execution. To achieve this, we can utilise a special function: the [->](https://dev.mysql.com/doc/refman/8.4/en/json.html) operator, which serves as an alias for the `json_extract` function in MySQL. This operator allows us to navigate JSON data and extract specific values. By using the `->` operator in conjunction with the `"%27))` payload, we can break out of the ORDER BY clause. The `->"%27))` payload effectively terminates the JSON extraction, bypasses the limitations imposed by the initial query and allows us to append additional SQL commands.

Note:
	`%27` url decoded is `'`

### **Payload**
- **Initial query**: The initial query that Laravel translates for sorting users by name is `SELECT * FROM users ORDER BY name ASC LIMIT 2`.
- **Breaking the query**: By injecting the `name->"%27))`, we can cause the query to break and thus create an opportunity to insert our own SQL.
- **Crafting the payload**: To exploit the vulnerability, we craft the payload to break out of the string and inject our SQL. The payload would be something like `name->"%27)) SQL INJECTION QUERY #`. Within the parameter value `name->`, the `->` is parsed by Laravel and replaced with JSON MySQL function. On the other hand, `"%27))` closes the previous string and condition. `SQL INJECTION QUERY` allows an attacker to write his own query. The character `#` comments out the rest of the query to prevent syntax errors.
- **Final result**: The payload for getting additional rows from the database would look like [https://10-10-133-129.p.thmlabs.com/query_users?sort=name-%3E%22%27))%20LIMIT%2010%23](https://10-10-133-129.p.thmlabs.com/query_users?sort=name-%3E%22%27))%20LIMIT%2010%23), while the query generated by Laravel to the MySQL database would be ``SELECT * FROM `users` ORDER BY json_unquote(json_extract(`name`, '$.""')) LIMIT 10#"')) ASC LIMIT 2`` including the injected payload. The above query would bypass the limit capability and fetch 10 rows from the table.
	![](Pasted%20image%2020250112195940.png)

