A covert technique known as **hidden link/image exploitation** in CSRF involves an attacker inserting a 0x0 pixel image or a link into a webpage that is nearly undetectable to the user. Typically, the `src or href` element of the image is set to a destination URL intended to act on the user's behalf without the user's awareness. It takes benefit of the fact that the user's browser transfers credentials like cookies automatically.
```html
<!-- Website --> 

<a href="https://mybank.thm/transfer.php" target="_blank">Click Here</a>  
<!-- User visits attacker's website while authenticated -->
```

*Note:*
	This technique preys on authenticated sessions and utilises a social engineering approach when a user may inadvertently perform operations on a different website while still logged in.

## How it works
- The attached VM represents Josh's machine, who uses Chrome to check his mailbox (`http://mailbox.thm:8081`) and log into his bank account (`http://mybank.thm:8080`). Since he is a financial broker by profession, he deals with many financial transactions daily and keeps his accounts logged into the browser.   
- The attacker somehow learns that Josh uses `mybank.thm:8080` for transactions, and his account is always logged in.  
- The attacker also had an account in the same bank, so he tried to log in and check for any vulnerabilities that he could use to get additional cash in his account.
- You can also log in to Firefox in the attached VM or any other browser using the username `GB82MYBANK5698` and password `GB82MYBANK5698` to understand the attacker's perspective and check the source code and how the client-side scripts work.
- While scanning, he found that no additional parameter was being sent from the bank app while transferring payment. Here is the code that handles the transfer of funds:

```php
<?php 
<form action="transfer.php" method="post">

    <label for="to_account">To Account:</label>
    <input type="text" id="to_account" name="to_account" required>

    <label for="amount">Amount:</label>
    <input type="number" id="amount" name="amount" required>

    <button type="submit">Transfer</button>
</form>
```

 Here, the attacker can employ the hidden image technique by simply crafting an email and luring the victim to click on a link. The attacker only knows Josh's email address, so he launches a social engineering attack by sending the following email to him.
	![](Pasted%20image%2020241224135317.png)

The most important thing is the image src attribute set to the bank transfer page link. The attacker can hide it or put a valid image with an [anchor](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a) tag redirecting to the bank transfer page.

```html
<a href="http://mybank.thm:8080/dashboard.php?to_account=GB82MYBANK5698&amount=1000" target="_blank">Click Here to Redeem</a>
```

- To understand the victim's perspective, navigate to Josh's mailbox at the `mailbox.thm:8081` to see a new email stating that he has won a trip to Dubai and to claim it, he has to click on a link directed to the MyBank vulnerable page without having CSRF protection.
- Once you (in reality, the victim) click on the link, he will be redirected to the bank page, and the funds will be transferred automatically.

**What was the missing link?**
	All the validations are correct and accurate; however, the server is not validating if the request comes from a legitimate user.

## Securing the Breach
- From a **pentester/red teamer perspective**, it is vital to pentest each request and response parameter of the form.  
- From a **secure coder perspective**, it is important to ensure that each request submitted to the web server carries a unique token so that the server can identify if it is clicked through a valid source.
- The bank IT team quickly identified the issue and added a CSRF token with each request submitted to the server. The following code contains the updated client-side code. We can see that there is an additional hidden parameter, `csrf_token`, which will be sent to the server with each request.
```html
<form method="post" action="">

        <label for="password">Password:</label>
        <input type="password" id="password" name="current_password" required>

        <label for="confirm_password">ConfirmPassword:</label>
        <input type="password" id="confirm_password" name="confirm_password" required>
        
		<input type="hidden" id="csrf_token" name="csrf_token" value="<?php echo $_COOKIE['csrf-token']; ?>">
		
        <button type="submit" name="password_submit" >Update Password</button>
    </form>submit">
    
</form> 
```

- On the server side, the server will verify if each incoming request contains the unique token; otherwise, it will reject the request.
- When the user clicks on the link, it won't transfer the funds as the request is missing a unique CSRF token required to validate the request.
	![](Pasted%20image%2020241224140017.png)

