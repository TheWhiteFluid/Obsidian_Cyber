Sometimes, we need more than just persisting to normal AD groups. What if we want to persist to all protected groups simultaneously?

# Persisting through AD Group Templates
Instead of directly adding our account to every privileged group, which the blue team can spot and remove, we can make our access more persistent and harder to detect. This can be done by **injecting into templates** that control how default groups are created or updated. One such template is the **AdminSDHolder container** in Active Directory (AD).

The **AdminSDHolder container** exists in every AD domain and acts as a **template for permissions** (Access Control List or ACL) for protected groups. These protected groups include high-privilege groups like "Domain Admins," "Administrators," "Enterprise Admins," and "Schema Admins."

A background process called **SDProp** runs every 60 minutes. It copies the ACL from the AdminSDHolder container to all protected groups. If we add a special permission (ACE) to the AdminSDHolder ACL that gives us control over protected groups, this permission will be automatically reapplied every hour.

This persistence method is tricky for the blue team to detect and fix. Even if they notice and remove the permission, it will **reappear within an hour** because of the SDProp process. Since this is part of AD's normal operations, it doesn’t trigger alerts, leaving the blue team puzzled and making it hard for them to identify the source of the problem.

## Persisting with AdminSDHolder
In order to deploy our persistence to the AdminSDHolder, we will use Microsoft Management Console (MMC). To avoid kicking users out of their RDP sessions, it will be best to RDP into THMWRK1 using your low privileged credentials, use the runas command to inject the Administrator credentials, and then execute MMC from this new terminal:
```
runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe
```

Once you have an MMC window, add the Users and Groups Snap-in (*File->Add Snap-In->Active Directory Users and Computers*). Make sure to enable Advanced Features (*View->Advanced Features*). We can find the *AdminSDHolder* group under *Domain->System*:
![](Pasted%20image%2020241122172409.png)

Navigate to the Security of the group (*Right-click->Properties->Security*):
![](Pasted%20image%2020241122172505.png)

Let's add our *low-privileged user* and grant *Full Control*:
1. Click **Add**.
2. Search for your low-privileged username and click **Check Names**.
3. Click **OK**.
4. Click **Allow** on **Full Control**.
5. Click **Apply**.
6. Click **OK**.
	![](Pasted%20image%2020241122172644.png)

## SDProp
Now we just need to wait 60 minutes, and our user will have full control over all Protected Groups. This is because the Security Descriptor Propagator (SDProp) service executes automatically every 60 minutes and will propagate this change to all Protected Groups. However, since we do not like to wait, let's kick off the process manually using Powershell. In the `C:\Tools\` directory, a script `Invoke-ADSDPropagation` is provided:

```markup
PS C:\Tools> Import-Module .\Invoke-ADSDPropagation.ps1 
PS C:\Tools> Invoke-ADSDPropagation
```

Once done, give it a minute and then review the security permissions of a Protected Group such as the Domain Admins group (you can use the search command to find this group):
	![](Pasted%20image%2020241122172823.png)

As can be seen, our low privilege user has full control over the group. You can verify that this will continue to propagate by removing your user from the security permissions and rerunning the PowerShell script. Your user will be added again. Interestingly, although we have permissions to modify the group, it does not automatically add us to the group:
	![](Pasted%20image%2020241122174006.png)

However, using our new permissions, we can add ourselves to this group:
	![](Pasted%20image%2020241122174027.png)

**It Is Going Downhill For The Blue Team**
Imagine combining this with the nesting groups of the previous task. Just as the blue team finished revoking your access through numerous group changes, 60 minutes later, you can just do it all again. Unless the blue team understands that the permissions are being altered through the AdminSDHolder group, they would be scratching their heads every 60 minutes. Since the persistence propagates through a legitimate AD service, they would most likely be none the wiser every time it happens. If you really want to persist, you can grant full control to the Domain Users group in the AdminSDHolder group, which means any low-privileged user would be granted full control over all Protected Groups. Combining this with a full DC Sync means the blue team will have to reset every single credential in the domain to flush us out completely.