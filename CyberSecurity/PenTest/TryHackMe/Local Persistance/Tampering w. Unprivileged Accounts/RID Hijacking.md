Another method to gain administrative privileges without being an administrator is changing some registry values to make the operating system think you are the Administrator.

When a user is created, an identifier called **Relative ID (RID)** is assigned to them. The RID is simply a numeric identifier representing the user across the system. When a user logs on, the LSASS process gets its RID from the SAM registry hive and creates an access token associated with that RID. If we can tamper with the registry value, we can make windows assign an Administrator access token to an unprivileged user by associating the same RID to both accounts.

In any Windows system, the default Administrator account is assigned the **RID = 500**, and regular users usually have **RID >= 1000**.

To find the assigned RIDs for any user, you can use the following command:
```shell-session
C:\> wmic useraccount get name,sid

Name                SID
Administrator       S-1-5-21-1966530601-3185510712-10604624-500
DefaultAccount      S-1-5-21-1966530601-3185510712-10604624-503
Guest               S-1-5-21-1966530601-3185510712-10604624-501
thmuser1            S-1-5-21-1966530601-3185510712-10604624-1008
thmuser2            S-1-5-21-1966530601-3185510712-10604624-1009
thmuser3            S-1-5-21-1966530601-3185510712-10604624-1010
```

The RID is the last bit of the SID (1010 for thmuser3 and 500 for Administrator). The SID is an identifier that allows the operating system to identify a user across a domain.

Now we only have to assign the RID=500 to thmuser3. To do so, we need to access the SAM using Regedit. The SAM is restricted to the SYSTEM account only, so even the Administrator won't be able to edit it. To run Regedit as SYSTEM, we will use psexec, available in `C:\tools\pstools` in your machine:
```shell-session
C:\tools\pstools> PsExec64.exe -i -s regedit
```

- **`PsExec64.exe`**:
    - This is the 64-bit version of **PsExec**, a lightweight utility that allows you to execute processes on a local or remote machine. It is part of the Sysinternals PsTools suite.
    - **PsExec** is particularly useful for running processes with elevated or system-level privileges, bypassing typical user-level permissions.
    
- **`-i`**:
    - The **`-i`** flag specifies that the process (in this case, `regedit`) should be started **interactively**, meaning it will be launched in a visible, interactive window that you can interact with from the desktop.
    - Without `-i`, the command would run the process in the background, and you wouldn't see the interface.
    
- **`-s`**:
    - The **`-s`** flag tells PsExec to run the process as the **System** account (LocalSystem). The System account has even higher privileges than the Administrator account, providing full control over the system, including access to areas normally restricted to administrators.
    
- **`regedit`**:
    - This is the executable for **Registry Editor**, the built-in tool for viewing and modifying the Windows registry. The registry contains critical settings for the operating system and installed software.


From Regedit, we will go to `HKLM\SAM\SAM\Domains\Account\Users\` where there will be a key for each user in the machine. Since we want to modify thmuser3, we need to search for a key with its RID in hex (`1010 = 0x3F2`). Under the corresponding key, there will be a value called `F`, which holds the user's effective RID at position 0x30:
	![[Pasted image 20240909205233.png]]

Notice the RID is stored using little-endian notation, so its bytes appear reversed.

![[Pasted image 20240909205431.png]]
		

We will now replace those two bytes with the RID of Administrator in hex (500 = 0x01F4), switching around the bytes (F401):
	![[Pasted image 20240909205345.png]]
		![[Pasted image 20240909205501.png]]
		
From now on, the next time thmuser3 logs in, LSASS will associate it with the same RID as Administrator and grant them the same privileges.